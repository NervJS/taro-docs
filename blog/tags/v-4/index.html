<!doctype html>
<html lang="zh-cn" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">8 篇博文 含有标签「v4」 | Taro 文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nervjs.github.io/taro-docs/blog/tags/v-4"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" property="og:title" content="8 篇博文 含有标签「v4」 | Taro 文档"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/taro-docs/home/runner/work/taro-docs/taro-docs/static/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://nervjs.github.io/taro-docs/blog/tags/v-4"><link data-rh="true" rel="alternate" href="https://nervjs.github.io/taro-docs/blog/tags/v-4" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://nervjs.github.io/taro-docs/en/blog/tags/v-4" hreflang="en"><link data-rh="true" rel="alternate" href="https://nervjs.github.io/taro-docs/blog/tags/v-4" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/taro-docs/blog/rss.xml" title="Taro 文档 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/taro-docs/blog/atom.xml" title="Taro 文档 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Taro 文档" href="/taro-docs/opensearch.xml">
<link rel="icon" href="/taro-docs/img/taro-logo_180.png">
<link rel="manifest" href="/taro-docs/manifest.json">
<meta name="theme-color" content="rgb(0, 0, 194)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/taro-docs/img/taro-logo_180.png">
<link rel="mask-icon" href="/taro-docs/img/taro-logo_180.png" color="rgb(62, 204, 94)">
<meta name="msapplication-TileImage" content="/taro-docs/img/taro-logo_180.png">
<meta name="msapplication-TileColor" content="#000">
<script src="https://storage.jd.com/taro-resource/tongji.js" async></script>
<script src="https://storage.jd.com/taro-docs/taro-doc-hotjar.js" async></script>
<script src="https://storage.360buyimg.com/quark-platform/sdk/ling-distribute-sdk-h5.0.7.0.js" async></script><link rel="stylesheet" href="/taro-docs/assets/css/styles.c3af84e0.css">
<link rel="preload" href="/taro-docs/assets/js/runtime~main.f8778fea.js" as="script">
<link rel="preload" href="/taro-docs/assets/js/main.a65eca9e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_FTVB" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_Cl8I" style="background-color:#f6ffed;color:#333333" role="banner"><div class="announcementBarPlaceholder_jchQ"></div><div class="content_wOjp announcementBarContent_XjGr"><div class="top_tip" role="alert">由凹凸实验室倾力打造的「Deco 设计稿一键生成多端代码」预览版正式上线啦，欢迎<a target="_blank" href="https://deco-preview.jd.com?from=taro-docs">免费试用</a>！</div></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_uIUG announcementBarClose_Q3LH"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/taro-docs/"><div class="navbar__logo"><img src="/taro-docs/img/logo-taro.png" alt="Taro logo" class="themedImage_sIkM themedImage--light_k_8f"><img src="/taro-docs/img/logo-taro.png" alt="Taro logo" class="themedImage_sIkM themedImage--dark_omlI"></div><b class="navbar__title text--truncate">Taro</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/taro-docs/docs/">4.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/taro-docs/docs/">4.x</a></li><li><a class="dropdown__link" href="/taro-docs/docs/3.x/">3.x</a></li><li><a class="dropdown__link" href="/taro-docs/docs/2.x/">2.x</a></li><li><a class="dropdown__link" href="/taro-docs/docs/1.x/">1.x</a></li><li><a class="dropdown__link" href="/taro-docs/versions">全部版本</a></li></ul></div><a class="navbar__item navbar__link" href="/taro-docs/docs/">文档</a><a class="navbar__item navbar__link" href="/taro-docs/docs/components-desc">组件库</a><a class="navbar__item navbar__link" href="/taro-docs/docs/apis/about/desc">API</a><a class="navbar__item navbar__link" href="/taro-docs/canIUse">CanIUse</a><a class="navbar__item navbar__link" href="/taro-docs/docs/guide">教程</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/taro-docs/blog">博客</a><a href="https://github.com/NervJS/taro/issues" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">问题反馈<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://deco-preview.jd.com?from=taro-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">设计稿生成代码<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">生态系统</a><ul class="dropdown__menu"><li><a href="https://github.com/NervJS/taro/discussions" target="_blank" rel="noopener noreferrer" class="dropdown__link">论坛<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://taro-ext.jd.com" target="_blank" rel="noopener noreferrer" class="dropdown__link">物料市场<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/taro-docs/showcase">案例</a></li><li><a href="https://nutui.jd.com/#/" target="_blank" rel="noopener noreferrer" class="dropdown__link">NutUI<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://taro-ui.jd.com" target="_blank" rel="noopener noreferrer" class="dropdown__link">Taro UI<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://taro.jd.com/jdmp/index.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">京东小程序<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_GE36"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_PQUr"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/taro-docs/blog/tags/v-4" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-cn">中文</a></li><li><a href="/taro-docs/en/blog/tags/v-4" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/nervjs/taro" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_stIc colorModeToggle_aD9j"><button class="clean-btn toggleButton_TOqH toggleButtonDisabled_lzkl" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_xrzQ"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_Qqrd"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_yEp4"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_CcZR"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_xiMu thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_Xm7B margin-bottom--md">全部</div><ul class="sidebarItemList_aY3X clean-list"><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2025/05/16/taro-harmony-c-api">Taro on Harmony C-API 版本正式开源</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2025/04/23/taro-on-harmony">Taro on Harmony ：助力业务高效开发纯血鸿蒙应用</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/11/22/harmony-virtual-list">Taro 鸿蒙技术内幕系列（五） - 剖析鸿蒙长列表优化实践</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/11/14/harmony-image">Taro 鸿蒙技术内幕系列（四）：JDImage 自研鸿蒙图片库</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/11/01/harmony-native-events">Taro 鸿蒙技术内幕系列（三） - 多语言场景下的通用事件系统设计</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/10/16/harmony-w3c-css">Taro 鸿蒙技术内幕系列（二）：如何让 W3C 标准的 CSS跑在鸿蒙上</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/09/29/harmony-react-on-arkts">Taro 鸿蒙技术内幕系列（一）：如何将 React 代码跑在 ArkUI 上文章</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/09/11/harmony-high-performance">京东鸿蒙上线前瞻——使用 Taro 打造高性能原生应用</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2024/01/18/harmony-hybrid">使用 harmony-hybrid 平台插件开发鸿蒙应用</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2023/03/29/D2_17">多编译内核生态下的极速研发体验</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2023/02/01/Taro-3.6">Taro v3.6 Reach 正式发布</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022/11/18/Taro-3.6-canary">Taro v3.6 代号为「Reach」，已发布 canary 版本</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022/07/26/Taro-3.5">Taro v3.5 正式发布：开发体验提升</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022/05/19/Taro-3.5-beta">Taro v3.5 beta 编译提速，支持 Webpack5、React 18...</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022/03/29/Taro-community">成为 Taro 社区的一员 - 贡献者晋级指南</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022/03/24/Taro-feature">速来围观，你最期待的 Taro 特性正在发布</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022-01-20-Taro-3.4">Taro 正式发布 3.4 版本 —— 全面支持 Preact 和 Vue3.2</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2022-01-19-how-to-join-Taro">如何参与大型开源项目-Taro 共建</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-12-08-Taro-3.5-canary">Taro v3.5 发布 canary 版本 —— 支持适配 鸿蒙</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-11-24-Taro-3.4-beta">Taro v3.4 发布 beta 版本 —— 支持使用 Preact 进行开发</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-10-14-Taro-React-Native-update">Taro React Native 重大更新：帮助开发者高效开发APP</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-08-13-Taro-3.3">Taro 正式发布 3.3 版本：支持使用 H5 标签与框架 DevTools</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-04-22-Taro-3.3-alpha">Taro 3.3 alpha 发布：用 ant-design 开发小程序？</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-04-08-taro-3.2">Taro 3.2 版本正式发布：React Native 支持，王者归来</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-03-10-taro-3-1-lts">Taro 正式发布 3.1 版本</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2021-02-08-taro-jxpp">Taro 助力京喜拼拼项目性能体验优化</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-12-15-taro-3-1-beta">Taro 3.1 beta 发布： 开放式架构新增 4 端支持</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-12-02-taro-3-2-0-cannary-1">增加 React Native 支持的 Taro 3.2.0 版本测试通告</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-09-01-taro-versions">Taro 版本升级权威指南</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-07-01-taro-3-0-0">Taro 3 正式版发布：开放式跨端跨框架解决方案</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-05-26-taro-3-rc">Taro 3.0 RC：React/Vue/Nerv 任你选</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-04-27-taro-build-jd">使用 Taro 快速开发京东小程序</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-04-27-taro-vs-jd">京东小程序 Taro 开发对比原生开发测评</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-4-13-taro-components">Taro Next H5 跨框架组件库实践</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-02-13-taro-next-alpha">Taro Next 发布预览版：同时支持 React / Vue / Nerv</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-01-08-taro-2-0">Taro 2.0：拥抱社区，拥抱变化</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2020-01-02-gmtc">小程序跨框架开发的探索与实践</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-12-03-jingxi-index">京喜首页（微信购物入口）跨端开发与优化实践</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-10-24-taro-open">Taro 邀你加入社区共建 — 社区共建倡议书</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-09-25-taro-flex">玩转 Taro 跨端之 flex 布局篇</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-07-10-taro-hooks">使用 React Hooks 重构你的小程序</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-06-21-taro-ext-club">Taro 「物料市场」及「交流社区」 惊喜上线</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-06-13-taro-1-3">Taro 1.3 震撼升级：全面支持 JSX 语法和 HOOKS</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-03-12-mini-program-framework-full-review">小程序框架全面测评</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-02-28-taro-h5-optimize">决战性能之巅 - Taro H5 转换与优化升级</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2019-02-25-taro-ui-2.0">Taro UI 2.0 发布：新增自定义主题功能，适配更多小程序</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-12-18-taro-1-2">Taro 1.2：将已有微信小程序转换为多端应用</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-11-05-taro-1-1">Taro 1.1 发布，全面支持微信/百度/支付宝小程序</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-09-18-taro-1-0-0">多端统一开发框架 Taro 1.0 正式发布</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-09-11-taro-in-jd">Taro 在京东购物小程序上的实践</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-08-24-the-birth-of-taro-ui">首个多端 UI 组件库 - Taro UI 发布</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-06-25-the-birth-of-taro">为何我们要用 React 来写小程序 - Taro 诞生记</a></li><li class="sidebarItem_yn4O"><a class="sidebarItemLink_sXzR" href="/taro-docs/blog/2018-06-07-Taro">多端统一开发框架 - Taro</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>8 篇博文 含有标签「v4」</h1><a href="/taro-docs/blog/tags">查看所有标签</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="在过去的一年中，Taro 经历了显著的蜕变，Taro For Harmony 方案完成从 ArkTS 方案到 C-API 方案的升级，成功实现了对纯血鸿蒙的完全适配，扩展了 Taro 的兼容平台家族，实现了对 H5、小程序、RN、原生鸿蒙多端的统一开发。"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2025/05/16/taro-harmony-c-api">Taro on Harmony C-API 版本正式开源</a></h2><div class="container_epbo margin-vert--md"><time datetime="2025-05-16T00:00:00.000Z" itemprop="datePublished">2025年5月16日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mCi1" id="taro-x-纯血鸿蒙">Taro x 纯血鸿蒙<a href="#taro-x-纯血鸿蒙" class="hash-link" aria-label="Taro x 纯血鸿蒙的直接链接" title="Taro x 纯血鸿蒙的直接链接">​</a></h2><p>在过去的一年中，Taro 经历了显著的蜕变，Taro For Harmony 方案完成从 ArkTS 方案到 C-API 方案的升级，成功实现了对纯血鸿蒙的完全适配，扩展了 Taro 的兼容平台家族，实现了对 H5、小程序、RN、原生鸿蒙多端的统一开发。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NaN6T9eOyiqx9Z6.png" alt="Taro X HarmonyOS" class="img_ZOZK"></p><p>去年 9 月，京东 APP 纯血鸿蒙 在鸿蒙应用商城正式上线，APP 中核心购物链路，如首页、搜索、商详、购物车、订单、结算和我京等页面，都是通过 Taro On Harmony C-API 版本进行开发，并且一上线就获得了华为的 S 级应用认证。</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/235448/38/25755/201048/66d7d844F0baea79b/adfe087ce5348c30.png" alt="JD Harmony" class="img_ZOZK"></p><p>今天，我们正式开源 Taro on Harmony C-API 版本，这次版本的发布，将带来更丰富的样式适配、更高效的渲染性能、更全面的组件支持，让开发者以 Web 范式的方式来开发出媲美原生鸿蒙性能的应用，为鸿蒙应用生态的丰富注入强大的动力。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/pic_hd.jpg" alt="JD Harmony APP" class="img_ZOZK"></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="整体技术架构">整体技术架构<a href="#整体技术架构" class="hash-link" aria-label="整体技术架构的直接链接" title="整体技术架构的直接链接">​</a></h2><p>Taro on Harmony 技术方案支持开发者使用 React DSL 来开发纯血鸿蒙应用，整体架构可以简单分为三层：</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img3.png" alt="Taro Harmony React" class="img_ZOZK"></p><p>最上层是应用业务代码所在的 ArkVM 层，这一层在 C-API 版本中主要运行业务代码、React 的核心代码以及少量的 Taro 运行时代码。</p><p>中间层是 Taro 的 CSSOM 和 TaroElement 树，负责处理上层 Taro 运行时代码传递下来的指令，比如 TaroElement 节点树创建，绑定关系以及设置属性等操作。</p><p>最下层存放的是 TaroRenderNode 虚拟节点树，这棵节点树和真正的上屏节点树是一一对应的关系，同时在 TaroRenderNode 节点树内会创建对应的 Yoga 节点。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img4.png" alt="Taro Harmony React DOM" class="img_ZOZK"></p><p>同时 Taro 还基于鸿蒙提供的 VSync 机制设置一套任务处理管线，来处理中间层和下层节点树产生的样式匹配、节点测量、节点布局、样式设置以及节点上屏等任务，来保证任务的时序性和最后上屏渲染结果的正确性。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="重点特性">重点特性<a href="#重点特性" class="hash-link" aria-label="重点特性的直接链接" title="重点特性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mCi1" id="丰富的能力支持">丰富的能力支持<a href="#丰富的能力支持" class="hash-link" aria-label="丰富的能力支持的直接链接" title="丰富的能力支持的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="常用组件和-api-支持">常用组件和 API 支持<a href="#常用组件和-api-支持" class="hash-link" aria-label="常用组件和 API 支持的直接链接" title="常用组件和 API 支持的直接链接">​</a></h4><p>在 C-API 版本的 Taro on Harmony 中，我们不仅完整支持了 React 18+，另外支持了 View、Text、Image、Video 等近 33 个 Taro 组件，对于常用的 API，如 getSystemInfo、getStorage 等也是在 C-API 版本中得到了完整的支持，而且针对逻辑较为复杂的 API 如：createSelectorQuery 以及 createIntersectionObserver，我们将这些 API 在 C++ 侧进行了重新的实现，大幅提升了他们的执行性能。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="常用样式支持">常用样式支持<a href="#常用样式支持" class="hash-link" aria-label="常用样式支持的直接链接" title="常用样式支持的直接链接">​</a></h4><p>在 C-API 版本中，我们对支持了大部分常见的 CSS 能力：</p><ul><li>支持常见的 CSS 样式和布局，支持 flex、伪类和伪元素</li><li>支持常见的 CSS 定位，绝对定位、fixed 定位</li><li>支持常见的 CSS 选择器和媒体查询</li><li>支持常见的 CSS 单位，比如 vh、vw 以及计算属性 calc</li><li>支持 CSS 变量以及安全区域等预定义变量</li></ul><p>同时，我们参考浏览器 CSSOM 的实现方式，在 C++ 实现了一套 CSSOM 逻辑，里面包含了样式解析、样式匹配、样式合成和应用整个链路的样式处理逻辑。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img5.png" alt="Taro Harmony CSS" class="img_ZOZK"></p><p>另外，Taro 引入了 Yoga 布局引擎来计算渲染节点的位置和大小，最大程度保证 Taro 构建出来的鸿蒙应用中渲染样式和 W3C 规范的一致性。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img6.png" alt="Taro Harmony Style" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="媲美原生-arkts-的高性能">媲美原生 ArkTS 的高性能<a href="#媲美原生-arkts-的高性能" class="hash-link" aria-label="媲美原生 ArkTS 的高性能的直接链接" title="媲美原生 ArkTS 的高性能的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="运行时逻辑下沉至-c">运行时逻辑下沉至 C++<a href="#运行时逻辑下沉至-c" class="hash-link" aria-label="运行时逻辑下沉至 C++的直接链接" title="运行时逻辑下沉至 C++的直接链接">​</a></h4><p>在 C-API 的版本中，我们将 ArkVM 层的 Taro 运行时内容削减到极致的薄，将 TaroElement 的大部分内容都下沉到了 C++ 侧，并在 ArkVM 层取消了他们之间父子关系的绑定，极大地提升了 TaroElement 相关逻辑的性能。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img7.png" alt="Taro Harmony CAPI" class="img_ZOZK"></p><p>另一方面，在 C++ 侧 Taro 会指令式地调用 ArkUI 在 C++ 侧提供的 API，来高效地创建节点、设置属性、绑定事件以及绘制上屏。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="提供长列表组件应对长列表场景">提供长列表组件应对长列表场景<a href="#提供长列表组件应对长列表场景" class="hash-link" aria-label="提供长列表组件应对长列表场景的直接链接" title="提供长列表组件应对长列表场景的直接链接">​</a></h4><p>Taro 还针对长列表场景针对性地提供了长列表类型组件，并对长列表类型组件进行了优化，提供了懒加载、预加载和节点复用等功能，有效地解决大数据量下的性能问题，提高应用的流畅度和用户体验。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img8.png" alt="Taro Harmony Virtual List" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="支持-c-api-混合原生的渲染模式">支持 C-API 混合原生的渲染模式<a href="#支持-c-api-混合原生的渲染模式" class="hash-link" aria-label="支持 C-API 混合原生的渲染模式的直接链接" title="支持 C-API 混合原生的渲染模式的直接链接">​</a></h3><p>Taro 的组件和 API 是以小程序作为基准来进行设计的，因此在实际的鸿蒙应用开发过程中，会出现部分所需的组件和 API 在 Taro 中不存在的情况，因为针对这种情况，在 C-API 版本中，Taro 提供了原生混合开发的能力，支持将原生页面或者原生组件混合编译到 Taro 鸿蒙项目中，支持 Taro 组件和鸿蒙原生组件在页面上的混合使用。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2025-05-16/img9.png" alt="Taro Harmony CAPI Hybrid" class="img_ZOZK"></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="使用教程">使用教程<a href="#使用教程" class="hash-link" aria-label="使用教程的直接链接" title="使用教程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mCi1" id="安装和使用">安装和使用<a href="#安装和使用" class="hash-link" aria-label="安装和使用的直接链接" title="安装和使用的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="安装-harmony-插件">安装 harmony 插件<a href="#安装-harmony-插件" class="hash-link" aria-label="安装 harmony 插件的直接链接" title="安装 harmony 插件的直接链接">​</a></h4><div class="language-bash codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-bash codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 使用 npm 安装</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> i @tarojs/plugin-platform-harmony-cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用 pnpm 安装</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">pnpm</span><span class="token plain"> i @tarojs/plugin-platform-harmony-cpp</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mCi1" id="添加插件配置">添加插件配置<a href="#添加插件配置" class="hash-link" aria-label="添加插件配置的直接链接" title="添加插件配置的直接链接">​</a></h4><div class="language-jsx codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-jsx codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports">os</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;os&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports">path</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;path&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">plugins</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;@tarojs/plugin-platform-harmony-cpp&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">harmony</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 当前仅支持使用 Vite 编译鸿蒙应用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">compiler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;vite&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Note: 鸿蒙工程路径，可以参考 [鸿蒙应用创建导读](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/start-with-ets-stage-0000001477980905-V2) 创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">projectPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">homedir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;projects/my-business-project&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Taro 项目编译到对应鸿蒙模块名，默认为 entry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">hapName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;entry&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mCi1" id="编译项目">编译项目<a href="#编译项目" class="hash-link" aria-label="编译项目的直接链接" title="编译项目的直接链接">​</a></h3><div class="language-bash codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-bash codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 编译鸿蒙应用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ taro build --type harmony_cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 编译鸿蒙原生组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ taro build native-components --type harmony_cpp</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果需要编译鸿蒙应用，同时使用编译鸿蒙原生组件，可以在页面配置中添加  <code>entryOption: false</code>  表示该页面是组件，同时可以用过  <code>componentName</code>  指定组件导出名。</p><div class="language-jsx codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-jsx codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">navigationBarTitleText</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hello World&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">  componentName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MyComponent&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">  entryOption</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结与展望">总结与展望<a href="#总结与展望" class="hash-link" aria-label="总结与展望的直接链接" title="总结与展望的直接链接">​</a></h2><p>Taro on Harmony C-API 版本经历了京东鸿蒙 APP 的实践，综合性能、生态以及开发体验来讲，毫无疑问已经成为了开发鸿蒙应用的最佳框架选型之一。</p><p>当下，我们也仍然在不断完善着鸿蒙的适配方案，基于当前的 Taro on Harmony C-API 方案，我们会进行多线程的架构升级以及 React 的 C++ 化，进一步提升 Taro 在鸿蒙端侧的性能，并极大地降低应用的丢帧率，整体进展也已经处于验证和测试阶段。</p><p>也欢迎大家一起参与 Taro on Harmony 的共建，你们的每一个建议，每一次提交，都是推进 Taro 继续往前走最大的动力。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2025/04/23/taro-on-harmony">Taro on Harmony ：助力业务高效开发纯血鸿蒙应用</a></h2><div class="container_epbo margin-vert--md"><time datetime="2025-04-23T00:00:00.000Z" itemprop="datePublished">2025年4月23日</time> · <!-- -->阅读需 13 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/luckyadam" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/1782542?s=400&amp;u=d20514a52100ed1f82282bcfca6f49052793c889&amp;v=4" alt="隔壁老李" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/luckyadam" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">隔壁老李</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会主席</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mCi1" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>纯血鸿蒙逐渐成为全球第三大操作系统，业界也掀起了适配鸿蒙原生的浪潮，用户迁移趋势明显，京东作为国民应用，为鸿蒙用户提供完整的购物体验至关重要。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A3687639d-b6bb-48eb-aa8c-05c5d8bfc76f%3Aimage.png?table=block&amp;id=1de0d09e-99e3-8088-adf0-e48b2bb8c41b&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>去年 9 月，京东 APP 纯血鸿蒙 在鸿蒙应用商城正式上线，APP 中核心购物链路，如首页、搜索、商详、购物车、订单、结算和我京等页面，都是通过 Taro on Harmony 方案进行开发，并且一上线就获得了华为的 S 级应用认证。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="taro-介绍">Taro 介绍<a href="#taro-介绍" class="hash-link" aria-label="Taro 介绍的直接链接" title="Taro 介绍的直接链接">​</a></h2><p>Taro 是由京东发起并维护的开放式跨端跨框架解决方案，支持以 Web 的开发范式来实现小程序、H5、原生 APP 的跨端统一开发，从 18 年开源至今，在 GitHub 已累计获得 36,000+ Stars。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A2eef6133-46f1-4243-9380-b84c58021378%3Aimage.png?table=block&amp;id=1de0d09e-99e3-80e6-ad81-c22e8fcff5e6&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>在过去的一年中，Taro 完成了鸿蒙适配方案的开发，Taro on Harmony 方案支持开发者使用 React DSL 来快速开发高性能原生鸿蒙应用，让 Taro 具备了一份代码同时跨鸿蒙、小程序、H5、React Native 多端的能力，可以让开发者以熟悉的方式来开发鸿蒙应用，大幅降低鸿蒙开发门槛，并且存量的 Taro 业务也能快速转成鸿蒙原生应用，可以节约大量研发成本。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="taro-on-harmony-适配方案的演进">Taro on Harmony 适配方案的演进<a href="#taro-on-harmony-适配方案的演进" class="hash-link" aria-label="Taro on Harmony 适配方案的演进的直接链接" title="Taro on Harmony 适配方案的演进的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mCi1" id="基于-arkts-的初始版本">基于 ArkTS 的初始版本<a href="#基于-arkts-的初始版本" class="hash-link" aria-label="基于 ArkTS 的初始版本的直接链接" title="基于 ArkTS 的初始版本的直接链接">​</a></h3><p>Taro 适配鸿蒙方案经过了多个版本的演进迭代，最初版本我们采用的是对接到鸿蒙原生 ArkTS 语言的方式来实现，这和 Taro 适配微信小程序的方案类似，都是通过模拟浏览器 DOM/BOM 环境，然后运行 React 代码构建出虚拟 DOM 树，再将虚拟 DOM 树以递归遍历的方式构建出宿主环境（小程序/鸿蒙）的渲染节点树，从而实现页面渲染。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A1824337e-2852-4feb-b67c-c2df8684e878%3A2023-12-04-14-58Rxh5858Hz12tATUfWO.png?table=block&amp;id=1de0d09e-99e3-804d-9dc6-c0285dd9d4ee&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>但这个方案的缺陷非常明显，那就是在 ArkTS 之上再桥接一层转换，导致性能相比原生存在一定差异，并且这个差异几乎没有办法可以抹平。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="基于-c-api-的全新版本">基于 C API 的全新版本<a href="#基于-c-api-的全新版本" class="hash-link" aria-label="基于 C API 的全新版本的直接链接" title="基于 C API 的全新版本的直接链接">​</a></h3><p>恰逢此时，鸿蒙为了方便三方框架与应用接入鸿蒙生态，在官方开发语言 ArkTS 之外，开放了更底层 C API 能力，提供了 C++ 层的 UI 节点创建、属性设置等能力（类似于 C++ 版本的 DOM），三方框架和应用可以基于 C API 构建高性能的解决方案和应用。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3Ab45a6ed0-7536-4055-a5cd-85ad0f733479%3Aimage.png?table=block&amp;id=1de0d09e-99e3-809a-a1b9-ddf319bf3556&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=960&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>C API 就是 Taro 想要的能力，与 Taro 的架构完美契合，Taro React 构建出来的虚拟 DOM 树可以通过 C API 直接去创建原生 UI 节点，省去了很多流程环节，并且可以将我们大部分的渲染管线处理沉到 C++ 中去，获得飞跃式的性能提升，所以基于 C API 我们首先设计并开发了单线程架构版本。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="单线程架构版本">单线程架构版本<a href="#单线程架构版本" class="hash-link" aria-label="单线程架构版本的直接链接" title="单线程架构版本的直接链接">​</a></h4><p>单线程架构版本的示意图如下，整个渲染过程均在主线程实现，业务代码在 ArkVM 中执行获得虚拟 DOM 树，同时读取样式数据，通过 React Reconciler ，在构建虚拟树时会调用 NAPI 在 C++ 侧构建出对应的 Element Tree，同时也会进行样式数据的解析处理，从而构建出 CSSOM 对象，Element Tree 和 CSSOM 对象会进行匹配从而构建出带有样式的 Render Tree，在这一步也会同时创建 yoga 节点，进行布局计算，最后会再基于布局计算的结果生成 C API 的 ArkNode Tree，从而实现上屏渲染。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A8b6d3829-3351-4b23-a0b2-cd9e182e14f5%3Aimage.png?table=block&amp;id=1de0d09e-99e3-8029-b026-e1c3831dcf63&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>目前京东鸿蒙 APP 中首页、搜推、我京、核心购物流程均是使用 Taro 单线程版本进行开发，性能和稳定性位于第一梯队。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A3f53d76c-a116-43b7-a6e4-4ad19251cd0f%3A11431743594310_.pic_hd.jpg?table=block&amp;id=1de0d09e-99e3-8081-8a18-fbe100bbc986&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="多线程架构版本">多线程架构版本<a href="#多线程架构版本" class="hash-link" aria-label="多线程架构版本的直接链接" title="多线程架构版本的直接链接">​</a></h4><p>单线程版本上线之后，我们也发现了单线程架构的不足，① 从业务代码的执行到渲染流程的处理都发生在主线程上，这导致了主线程的过载，使得应用无法及时响应用户的操作，从而引发了用户体验上的卡顿，随着业务逻辑的增加和复杂性的提升，这种卡顿现象会越发明显；② 在单线程架构下，代码都是需要内置到应用包里，这样就无法实现业务代码的动态下发更新。</p><p>所以，为了解决以上问题，进一步提升应用性能，和应对未来更多业务场景需求的可能性，我们实现了多线程架构。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3Af873dd4e-fde0-498f-8f01-61bafef7338c%3Aimage.png?table=block&amp;id=1de0d09e-99e3-804b-bc2c-ec73b07330cb&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>相较于单线程架构，多线程架构将整个业务代码执行和渲染的过程拆分到了三个线程，每个线程各司其职，让任务的执行更加合理，不会造成主线程的堵塞，这样的架构主要带来三个好处。</p><p>1.<strong>业务逻辑不再堵塞主流程</strong>，完全剥离到了单独的线程执行，之前容易出现卡顿、甚至 APP Freeze 的页面基本不再有问题，例如商详接入之后滑动页面变得更加流畅；</p><p>2.<strong>动画执行和渲染不再卡顿</strong>，动画的执行交由 Background 线程管控，不再和 JS 线程有冲突问题，动画支持满帧渲染；</p><p>3.<strong>支持动态化的能力</strong>，在性能上可以与原生相媲美，同时还能支持动态下发，支持更新远端 JS 资源来实现 APP 内容的更新，让业务具备快速验证和免发版的能力。</p><p>目前多线程版本正在我们的业务中进行试点接入，很快就会正式上线。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="taro-on-harmony-方案特性">Taro on Harmony 方案特性<a href="#taro-on-harmony-方案特性" class="hash-link" aria-label="Taro on Harmony 方案特性的直接链接" title="Taro on Harmony 方案特性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mCi1" id="丰富的能力支持">丰富的能力支持<a href="#丰富的能力支持" class="hash-link" aria-label="丰富的能力支持的直接链接" title="丰富的能力支持的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="常用组件和-api-支持">常用组件和 API 支持<a href="#常用组件和-api-支持" class="hash-link" aria-label="常用组件和 API 支持的直接链接" title="常用组件和 API 支持的直接链接">​</a></h4><p>在 C-API 版本的 Taro For Harmony 中，我们不仅完整支持了 React 18+，另外支持了 View、Text、Image、Video 等近 33 个 Taro 组件，对于常用的 API，如 getSystemInfo、getStorage 等也是在 C-API 版本中得到了完整的支持，而且针对逻辑较为复杂的 API 如：createSelectorQuery 以及 createIntersectionObserver，我们将这些 API 在 C++ 侧进行了重新的实现，大幅提升了他们的执行性能。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="常用样式支持">常用样式支持<a href="#常用样式支持" class="hash-link" aria-label="常用样式支持的直接链接" title="常用样式支持的直接链接">​</a></h4><p>在 C-API 版本中，我们对支持了大部分常见的 CSS 能力：</p><ul><li>支持常见的 CSS 样式和布局，支持 flex、伪类和伪元素</li><li>支持常见的 CSS 定位，绝对定位、fixed 定位</li><li>支持常见的 CSS 选择器和媒体查询</li><li>支持常见的 CSS 单位，比如 vh、vw 以及计算属性 calc</li><li>支持 CSS 变量以及安全区域等预定义变量</li></ul><p>同时，我们参考浏览器 CSSOM 的实现方式，在 C++ 实现了一套 CSSOM 逻辑，里面包含了样式解析、样式匹配、样式合成和应用整个链路的样式处理逻辑。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A98ea6485-da68-4583-9b18-b8f1366e84e5%3Aimage.png?table=block&amp;id=1de0d09e-99e3-800a-8a32-d836783876f1&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1170&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>另外，Taro 引入了 Yoga 布局引擎来计算渲染节点的位置和大小，最大程度保证 Taro 构建出来的鸿蒙应用中渲染样式和 W3C 规范的一致性。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3Aa740c240-1acc-4021-bf69-3db739ec4391%3Aimage.png?table=block&amp;id=1de0d09e-99e3-8047-8200-cf9f60302c6e&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="媲美原生-arkts-的高性能">媲美原生 ArkTS 的高性能<a href="#媲美原生-arkts-的高性能" class="hash-link" aria-label="媲美原生 ArkTS 的高性能的直接链接" title="媲美原生 ArkTS 的高性能的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="运行时逻辑下沉至-c">运行时逻辑下沉至 C++<a href="#运行时逻辑下沉至-c" class="hash-link" aria-label="运行时逻辑下沉至 C++的直接链接" title="运行时逻辑下沉至 C++的直接链接">​</a></h4><p>在 C-API 的版本中，我们将 ArkVM 层的 Taro 运行时内容削减到极致的薄，将 TaroElement 的大部分内容都下沉到了 C++ 侧，并在 ArkVM 层取消了他们之间父子关系的绑定，极大地提升了 TaroElement 相关逻辑的性能。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A6d4739f0-41d3-4177-b293-dafc34817472%3Aimage.png?table=block&amp;id=1de0d09e-99e3-801f-8854-fa40d21f1afb&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><p>另一方面，在 C++ 侧 Taro 会指令式地调用 ArkUI 在 C++ 侧提供的 API，来高效地创建节点、设置属性、绑定事件以及绘制上屏。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="提供长列表组件应对长列表场景">提供长列表组件应对长列表场景<a href="#提供长列表组件应对长列表场景" class="hash-link" aria-label="提供长列表组件应对长列表场景的直接链接" title="提供长列表组件应对长列表场景的直接链接">​</a></h4><p>Taro 还针对长列表场景针对性地提供了长列表类型组件，并对长列表类型组件进行了优化，提供了懒加载、预加载和节点复用等功能，有效地解决大数据量下的性能问题，提高应用的流畅度和用户体验。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3A104a946f-10d1-4403-87a8-f137e2a8e3ab%3Aimage.png?table=block&amp;id=1de0d09e-99e3-80dd-ac4f-d782ad2b53d4&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="支持-c-api-混合原生的渲染模式">支持 C API 混合原生的渲染模式<a href="#支持-c-api-混合原生的渲染模式" class="hash-link" aria-label="支持 C API 混合原生的渲染模式的直接链接" title="支持 C API 混合原生的渲染模式的直接链接">​</a></h3><p>Taro 的组件和 API 是以小程序作为基准来进行设计的，因此在实际的鸿蒙应用开发过程中，会出现部分所需的组件和 API 在 Taro 中不存在的情况，因为针对这种情况，在 C-API 版本中，Taro 提供了原生混合开发的能力，支持将原生页面或者原生组件混合编译到 Taro 鸿蒙项目中，支持 Taro 组件和鸿蒙原生组件在页面上的混合使用。</p><p><img loading="lazy" src="https://luckyadam.notion.site/image/attachment%3Aca51307a-d51f-460c-b5b8-1c930843f445%3Aimage.png?table=block&amp;id=1de0d09e-99e3-806c-b10f-fbafa2ef8a98&amp;spaceId=9a0c7639-98bb-4652-b1e5-2d1a6b23d718&amp;width=1420&amp;userId=&amp;cache=v2" class="img_ZOZK"></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>Taro 鸿蒙方案基于鸿蒙 CAPI 进行构建，实现了将 React DSL 直接对接到 C++ 侧来运行整体渲染管线，从而实现了与原生齐平的渲染性能，同时 Taro 鸿蒙方案是多线程架构的方案，在应用渲染性能、操作响应时延上都在业界做到极致，并且 Taro 鸿蒙方案支持动态更新，是行业首创且经过大规模 APP 应用场景验证的开发框架，综合性能、生态以及开发体验来讲，毫无疑问已经成为了开发鸿蒙应用的最佳框架选型之一。</p><p>目前，我们也仍然在不断完善着鸿蒙的适配方案，目前在渲染性能提升方面我们正在进行 React C++ 化的探索，整体进展也已经处于验证和测试阶段，同时也在进行自研布局引擎的探索，在进一步提升渲染性能的同时，为业务提供更丰富的样式写法支持；此外，在开发效率提升方面，我们也正在进行开发调试工具的探索开发，为业务提供热重载、源码定位、断点调试、元素审查等能力，提升效率和开发体验。</p><p>在近期，我们会将已经在京东鸿蒙 APP 久经考验的单线程架构版本开源出来，为开源社区贡献一份力量，为鸿蒙应用生态的丰富注入强大的动力。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2024/11/22/harmony-virtual-list">Taro 鸿蒙技术内幕系列（五） - 剖析鸿蒙长列表优化实践</a></h2><div class="container_epbo margin-vert--md"><time datetime="2024-11-22T00:00:00.000Z" itemprop="datePublished">2024年11月22日</time> · <!-- -->阅读需 15 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/liubb0516" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/106364053?v=4" alt="Emma" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/liubb0516" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Emma</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 贡献者</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/148159/17/47762/49649/673ffa2fF63c5cee5/99599074b6ae93ca.png" alt="首图" class="img_ZOZK"></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="问题背景">问题背景<a href="#问题背景" class="hash-link" aria-label="问题背景的直接链接" title="问题背景的直接链接">​</a></h2><p>长列表类型组件（例如 WaterFlow, List）在应用开发中被广泛使用，特别适合商品列表、订单列表、消息列表等需要无限滚动的场景。这些组件通常包含大量结构相似的子组件，它们的样式和布局相似，但数据内容各异，且数据通常来自网络。</p><p>在典型的 Taro React 应用中 ，正常的列表处理流程如下：</p><ol><li>生成或从远端服务器加载数据。</li><li>框架基于最新数据生成新的虚拟 DOM 树。</li><li>框架使用 diff 算法或其他机制，根据虚拟 DOM 树的变化，触发对应的更新指令。</li><li>运行时捕获框架的更新请求，并实际更新视图。</li></ol><p>然而，如果加载的数据量非常大，可能会引发严重的性能问题，导致视图在一段时间内无法响应用户操作。为了解决这个问题，我们为 Taro 长列表类型组件提供了懒加载、预加载和组件复用等功能，专门针对长列表类型组件进行了优化，有效地解决大数据量下的性能问题，提高应用的流畅度和用户体验。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="taro-虚拟列表">Taro 虚拟列表<a href="#taro-虚拟列表" class="hash-link" aria-label="Taro 虚拟列表的直接链接" title="Taro 虚拟列表的直接链接">​</a></h3><p>目前 Taro 在其他端侧已支持<a href="https://docs.taro.zone/docs/next/virtual-list/" target="_blank" rel="noopener noreferrer">虚拟列表</a>，并在实践中证明虚拟列表可以极大程度提升列表渲染性能。出于性能考虑，Taro 通过 CAPI 对接鸿蒙 ArkUI，将更多的运行时逻辑如组件、动效、测算和布局等逻辑下沉到了 C++ 层。虚拟列表也需要在 C++层重新设计实现，在只渲染当前可视区域视图的基础上，我们还加入了组件预加载，数据预请求和组件复用等高阶功能，有效地解决大数据量下的性能问题，提高应用的流畅度和用户体验，并大幅度降低了应用内存占用。以下是 Taro 虚拟列表渲染流程：</p><p><img loading="lazy" src="https://img20.360buyimg.com/img/jfs/t1/247467/7/23875/28060/673b1b6cFdf12e18e/226b35e0f280f63c.png" alt="虚拟列表" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="优化方案">优化方案<a href="#优化方案" class="hash-link" aria-label="优化方案的直接链接" title="优化方案的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="nodeadapter-介绍">NodeAdapter 介绍<a href="#nodeadapter-介绍" class="hash-link" aria-label="NodeAdapter 介绍的直接链接" title="NodeAdapter 介绍的直接链接">​</a></h4><p>当前 ArkTS 滚动类容器使用 LazyForEach 时，框架会根据滚动容器可视区域按需创建组件，但是鸿蒙 CAPI 接口不支持 LazyForEach 功能。作为 ArkTS 侧 LazyForEach 的替代方案，开发者可以使用 NodeAdapter 对象在 C++ 侧实现类似的效果。NodeAdapter 已支持 List、Grid、Swiper 和 WaterFlow 四种主要的长列表组件。</p><p>本文将以 WaterFlow 组件为例，详细介绍如何利用 NodeAdapter 对象和 CAPI 提供的能力来实现长列表组件的懒加载、预加载和组件复用。</p><p>NodeAdapter 通过特定的事件机制时需要进行相关的处理。以下是 NodeAdapter 的典型工作流程：</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/214063/21/46994/43111/67330f8cF5dd5b1d3/0c3b04cea1c4a205.png" alt="NodeAdapter" class="img_ZOZK"></p><p>通过这种方式，开发者可以更好地控制长列表组件的行为，从而显著提升其性能。</p><p>NodeAdapter 的创建和挂载如下：</p><ul><li>创建 NodeAdapter 对象并挂载回调处理函数</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RenderNode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="color:#00009f">public</span><span class="token base-clause"> std</span><span class="token base-clause double-colon punctuation" style="color:#393A34">::</span><span class="token base-clause class-name">enable_shared_from_this</span><span class="token base-clause operator" style="color:#393A34">&lt;</span><span class="token base-clause class-name">RenderNode</span><span class="token base-clause operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RenderNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">str_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">node_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">child_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reuseId_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string str_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ArkUIBaseNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> node_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string reuseId_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ArkUIBaseNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> child_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ArkUIWaterFlowAdapter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handle_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapter_Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 初始化懒加载数据。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> renderNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">RenderNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        renderNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">reuseId_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reuse&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">renderNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 设置懒加载数据。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapter_SetTotalNodeCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 设置懒加载回调事件。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapter_RegisterEventReceiver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OnStaticAdapterEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>将 NodeAdapter 绑定到对应的容器组件上</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 引入懒加载模块。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetLazyAdapter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ArkUIWaterFlowAdapter</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">adapter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArkUI_AttributeItem item</span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> adapter</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nativeModule_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">setAttribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NODE_WATER_FLOW_NODE_ADAPTER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>回调处理函数定义</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnAdapterEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ArkUI_NodeAdapterEvent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_GetType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_GetItemIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> NODE_ADAPTER_EVENT_ON_GET_NODE_ID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">OnNewItemIdCreated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> NODE_ADAPTER_EVENT_ON_ADD_NODE_TO_ADAPTER</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">OnNewItemAttached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">OnItemDetached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mCi1" id="懒加载">懒加载<a href="#懒加载" class="hash-link" aria-label="懒加载的直接链接" title="懒加载的直接链接">​</a></h4><p>懒加载特性会根据容器组件能够容纳显示的组件数量按需加载数据，创建对应的 Item 组件，并挂载在容器组件树根组件上。整体渲染流程如下图所示(备注:图片来自 HarmonyOS NEXT 官网)：</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/207202/22/32362/17737/66f23379F2bc52482/b6ad124768016e4d.png" alt="渲染流程" class="img_ZOZK"></p><p>懒加载创建组件示例代码：</p><ul><li>创建组件唯一 ID：</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 分配ID给需要显示的Item，用于ReloadAllItems场景的元素diff。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnNewItemIdCreated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ArkUI_NodeAdapterEvent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_GetItemIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">hash</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> hashId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">hash</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">std</span><span class="token generic-function generic class-name double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function generic class-name">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#d73a49">reinterpret_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">std</span><span class="token generic-function generic class-name double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function generic class-name">uintptr_t</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data_</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_SetNodeId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>处理组件上屏事件：</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 需要新的Item显示在可见区域。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnNewItemAttached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ArkUI_NodeAdapterEvent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_GetItemIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> data_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> newNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data_</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// RecycleManager(newNode);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 创建新的组件元素。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> flowItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ArkUIFlowItemNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> textNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ArkUITextNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetTextContent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">str_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetFontSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetPercentWidth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetHeight</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetTextAlign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ARKUI_TEXT_ALIGNMENT_CENTER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> color </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFF0000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetBackgroundColor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">color</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flowItem</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">AddChild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">textNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flowItem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">child_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    items_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert_or_assign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 设置需要展示的组件元素。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_SetItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mCi1" id="预加载">预加载<a href="#预加载" class="hash-link" aria-label="预加载的直接链接" title="预加载的直接链接">​</a></h3><p>尽管按需加载列表项可以提升长列表的性能，但在用户快速滑动，特别是数据中包含大量图片和视频的情况下，可能会出现渲染不及时导致的白块现象，影响用户体验。</p><p>为了解决该问题，NodeAdapter 支持设置 cachedCount 属性来指定缓存数量，当设置 cachedCount 后，除了容器类组件内显示的 Item 外，还将预先创建 cachedCount 条数据作为缓存。这样可以有效避免白块现象，确保用户在滑动过程中有流畅的视觉体验。</p><p>一般而言，<strong>缓存的 cachedCount 为一屏显示数据的一半的时候，效果较好。</strong></p><p>整体渲染流程如下图所示(备注:图片来自 HarmonyOS NEXT 官网)：</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/124119/7/48766/62271/66f2337cF99412cfe/67e9b88733775837.png" alt="渲染流程" class="img_ZOZK"></p><ul><li>cachedCount 的使用方法如下所示：</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setCachedCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int32_tcount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArkUI_NumberValue value</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nativeModule_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">setAttribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NODE_WATER_FLOW_CACHED_COUNT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mCi1" id="数据预请求">数据预请求<a href="#数据预请求" class="hash-link" aria-label="数据预请求的直接链接" title="数据预请求的直接链接">​</a></h4><p>尽管长列表组件支持无限滚动，但在实际业务场景中，上层业务通常会采用分页方式来加载数据。以京东 App 首页为例，一屏可以显示 6 个商品，一次网络请求加载 20 条数据。如果在滑动到底部时才发起请求加载新数据，可能会出现明显的加载停顿，尤其是在网络时延较高的情况下，这种停顿会更加突出。</p><p>为了解决该问题，我们可以调整请求新数据的时机。具体来说，当还未上屏的数据数量低于某个阈值时，就提前发起请求来加载新数据。这样可以预先准备好下一批数据，避免在滑动过程出现加载停顿。</p><p>数据预请求示例代码：</p><ul><li>注册 NODE_WATER_FLOW_ON_SCROLL_INDEX 事件，获取当前容器显示的起始位置/终止索引</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RegisterOnScrollIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nativeModule_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">registerNodeEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NODE_WATER_FLOW_ON_SCROLL_INDEX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>请求加载新数据</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ArkUI_NodeEvent</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> handle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeEvent_GetNodeHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeEvent_GetEventType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeEvent_GetTargetId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> componentEvent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeEvent_GetNodeComponentEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventType </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> NODE_WATER_FLOW_ON_SCROLL_INDEX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> componentEvent</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> componentEvent</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> waterFlow</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">adapter_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetDataSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> waterFlow</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">UpdateSectionSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                waterFlow</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">adapter_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">InsertItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面是使用懒加载、预加载和数据预请求的前后对比（左边为使用后，右边为使用前）：</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="组件复用">组件复用<a href="#组件复用" class="hash-link" aria-label="组件复用的直接链接" title="组件复用的直接链接">​</a></h4><p>对于离开可视区域的组件，NodeAdapter 不会主动释放它们，而是通过 NODE_ADAPTER_EVENT_ON_REMOVE_NODE_FROM_ADAPTER 回调通知开发者。这样可以让开发者根据实际情况决定是释放组件对象，还是将其放入复用缓存池以便后续使用。</p><p>Taro 采用了组件复用的策略，<strong>当组件离开可视区域时，并不会立即释放其占用的资源，而是将其放入复用缓存池中。</strong></p><p>当用户滚动到其他位置，需要渲染新的子组件时，Taro 会先检查缓存池中是否有结构相似的组件。如果找到了相似的组件，就直接从缓存池中取出该组件，并更新其属性和事件。</p><p>这种做法可以有效降低应用的内存占用，减少频繁创建和销毁组件带来的性能开销，提升应用的整体性能和用户体验。</p><p>原理如下图所示：</p><p><img loading="lazy" src="https://img14.360buyimg.com/img/jfs/t1/101938/1/51422/52628/66f2328dFed641532/809db22518d091df.png" alt="组件复用" class="img_ZOZK"></p><p>识别子组件相似性对于组件复用至关重要。由于上层业务开发者对 Item 的结构和子组件的相似性有着全面的了解, 为了更准确地识别可复用的子组件, Taro 框架引入了一个<strong>新的属性 reuseId</strong>，表示以当前组件为根组件的子组件树可以被复用。开发者可以根据业务场景和 Item 结构特点，灵活地标记出具有相似性的子组件。</p><p>当列表中存在多个具有相同 reuseId 的子组件树时, 框架会自动识别并复用这些子组件, 而不是重新创建和渲染它们。</p><p><img loading="lazy" src="https://img30.360buyimg.com/img/jfs/t1/103040/30/52968/367786/66f25fd0F0b7dd064/1a34cfc6a3cb4436.png" alt="首页组件复用" class="img_ZOZK"></p><p>组件复用是 Taro 优化性能的重要策略，其流程如下：</p><ol><li><p>从缓存池中获取与当前组件 reuseId 相匹配的子组件。</p></li><li><p>对获取到的组件进行类型比较(diff)：</p><ul><li>如果组件类型相同，则认为可以直接复用该组件，进入下一步；</li><li>如果组件类型不同，则销毁该组件及其所有子组件，并创建对应的新组件后挂载，结束复用流程。</li></ul></li><li><p>对于类型相同的组件，进一步比较保其属性：</p><ul><li>通过 diff 算法识别出属性的差异部分；</li><li>将差异部分的属性更新到复用的组件上，保证组件的属性与当前组件状态一致。</li></ul></li><li><p>更新组件的事件绑定，确保事件处理函数与当前组件的事件处理逻辑相匹配。</p></li><li><p>递归地对该组件的子组件重复步骤 2 到步骤 4，实现对整个子树的深度复用。</p></li></ol><ul><li>组件复用示例代码：</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 管理NodeAdapter生成的元素。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">unordered_map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ArkUI_NodeHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">RenderNode</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> items_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 管理回收复用组件池，key为 reuseId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">unordered_map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">unordered_set</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">RenderNode</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cachedItems_</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>组件回收逻辑：</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Item从可见区域移除。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnItemDetached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ArkUI_NodeAdapterEvent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_GetRemovedNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 放置到缓存池中进行回收复用。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> it </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> items_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> items_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> renderNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">renderNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">reuseId_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cachedItems_</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">renderNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">reuseId_</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">renderNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>组件上屏逻辑：</li></ul><div class="language-cpp codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-cpp codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isInitilaizedNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">RenderNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> reuseId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">reuseId_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> it </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cachedItems_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reuseId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> cachedItems_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> setIt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">setIt </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">erase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">setIt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initRenderNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">RenderNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">RenderNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> reuseNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reuseNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">child_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reuseNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">child_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> newText </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">dynamic_pointer_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ArkUITextNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">child_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理子组件，属性 diff 和更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newText </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">str_ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> reuseNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">str_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newText</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetTextContent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">str_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reuseNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reuseNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">child_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RecycleManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">RenderNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isInitilaizedNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> it </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cachedItems_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">reuseId_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> cachedItems_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 组件复用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> reuseIt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">begin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> reuseNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reuseIt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">initRenderNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reuseNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">erase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reuseIt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 创建新的元素。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> flowItem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ArkUIFlowItemNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> textNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ArkUITextNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetTextContent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">str_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetFontSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetPercentWidth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetHeight</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetTextAlign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ARKUI_TEXT_ALIGNMENT_CENTER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> color </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFF0000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        textNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetBackgroundColor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">color</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        flowItem</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">AddChild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">textNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flowItem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">child_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> textNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 需要新的Item显示在可见区域。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnNewItemAttached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ArkUI_NodeAdapterEvent </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_GetItemIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> data_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> newNode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data_</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">RecycleManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    items_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert_or_assign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newNode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 设置需要展示的元素。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">OH_ArkUI_NodeAdapterEvent_SetItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newNode</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">node_</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>本文重点阐述了一种针对长列表类型组件的优化方案，利用 CAPI 提供的能力，结合组件复用方案，有效地提升了页面性能。文中还附带了 CAPI 实现 demo 以供参考。目前这一方案已经在京东 App 的多个核心页面得到应用，包括首页、搜索结果页和购物车等，实践表明页面的<strong>加载和更新速度平均提升了 38%，组件复用降低京东 App 首页 54% 的内存占用</strong>。该方案在实际项目中的成功应用，为 CAPI 实现长列表组件，及长列表组件性能优化提供了有益的参考和借鉴。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="下期预告">下期预告<a href="#下期预告" class="hash-link" aria-label="下期预告的直接链接" title="下期预告的直接链接">​</a></h3><p><img loading="lazy" src="https://img30.360buyimg.com/img/jfs/t1/244935/34/24667/267488/673ffa36F6da4f1ed/c22723a2134f55ab.png" alt="尾图" class="img_ZOZK"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2024/11/14/harmony-image">Taro 鸿蒙技术内幕系列（四）：JDImage 自研鸿蒙图片库</a></h2><div class="container_epbo margin-vert--md"><time datetime="2024-11-14T00:00:00.000Z" itemprop="datePublished">2024年11月14日</time> · <!-- -->阅读需 19 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/helele90" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/4125469?v=4" alt="HeXiao" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/helele90" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">HeXiao</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 贡献者</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/learrn" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/13703452?v=4" alt="learnNG" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/learrn" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">learnNG</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 贡献者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NaN6T9eOyiqx9Z6.png" class="img_ZOZK"></p><blockquote><p>基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mCi1" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>2024 年初，京东正式启动了鸿蒙 APP 的开发工作。由于电商 APP 大量依赖图片来展示商品信息，对图片库的性能和加载体验要求极高，因此图片库被作为核心基础能力提前纳入京东鸿蒙首期基础建设计划。本文将详细介绍京东自研鸿蒙图片库的开发过程及其技术原理。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="技术实现">技术实现<a href="#技术实现" class="hash-link" aria-label="技术实现的直接链接" title="技术实现的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="前期调研">前期调研<a href="#前期调研" class="hash-link" aria-label="前期调研的直接链接" title="前期调研的直接链接">​</a></h4><p>经过前期的调研，我们发现<code>HarmonyOS</code>平台的网络图片加载主要依赖以下两种实现方式：</p><h6 class="anchor anchorWithStickyNavbar_mCi1" id="系统---image-组件">系统 - Image 组件<a href="#系统---image-组件" class="hash-link" aria-label="系统 - Image 组件的直接链接" title="系统 - Image 组件的直接链接">​</a></h6><p>仅仅提供基础的图片组件用于图片加载，但功能、图片格式支持和扩展性都较弱，无法实现更丰富的图片库能力。存在的一些问题：</p><ul><li>性能一般，尤其在同时加载多个图片时较慢</li><li>不支持 AVIF 图片格式并且无法扩展</li><li>无法搭建完善的质量监控体系</li><li>无法控制和扩展图片下载、解码、缓存流程，无法加入更多的性能优化手段和扩展定制</li></ul><h5 class="anchor anchorWithStickyNavbar_mCi1" id="第三方库---imageknife">第三方库 - ImageKnife<a href="#第三方库---imageknife" class="hash-link" aria-label="第三方库 - ImageKnife的直接链接" title="第三方库 - ImageKnife的直接链接">​</a></h5><p>社区参考 Android 图片库<code>Glide</code>的<code>HarmonyOS</code>版本实现，使用<code>ArkTS</code>开发。虽然能力比系统<code>Image</code>组件完善，但在性能、稳定性和扩展性都无法满足诉求。存在的一些问题：</p><ul><li>性能一般</li><li>代码质量一般，存在一些 bug 和 Crash</li><li>整体架构、扩展性设计不够，无法加入更多的性能优化手段和扩展定制</li></ul><p>由于系统<code>Image</code>组件和<code>ImageKnife</code>开源库无法满足诉求，我们决定自主研发鸿蒙图片库。此外，随着<code>HarmonyOS</code>系统的引入，客户端在原有的<code>iOS</code>和<code>Android</code>基础设施上新增了一个平台，增加了维护成本。现有 iOS/Android 图片库也存在双端部分能力不一致的情况。集团内部期望未来的客户端基础设施能够支持跨端复用，以提高开发效率和一致性。</p><p>因此,团队选择基于<code>C++</code>为核心进行图片库开发，这种实现方式有以下优势：</p><ul><li>跨端复用：将更多的公共模块下沉到<code>C++</code>层以实现跨端复用，未来图片库可以扩展到<code>iOS</code>和<code>Android</code>平台。</li><li>适配 Taro：<code>Taro Harmony</code>框架基于鸿蒙<code>CAPI</code>进行开发，需要依赖<code>CAPI</code>的图片组件，可以避免<code>ArkTS</code>和<code>C++</code>之间频繁通信带来的性能损耗。</li><li>高性能：<code>C++</code>在运行时性能上优于<code>ArkTS</code>。</li></ul><h3 class="anchor anchorWithStickyNavbar_mCi1" id="jdimage-能力">JDImage 能力<a href="#jdimage-能力" class="hash-link" aria-label="JDImage 能力的直接链接" title="JDImage 能力的直接链接">​</a></h3><p><img loading="lazy" src="https://img14.360buyimg.com/img/s1500x0_jfs/t1/211373/11/47107/74028/6735b559F4b6199c8/7b893857d765533c.png" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="架构设计">架构设计<a href="#架构设计" class="hash-link" aria-label="架构设计的直接链接" title="架构设计的直接链接">​</a></h3><p>由于图片库使用<code>C++</code>进行跨端开发，面临不同平台之间的兼容性挑战，部分功能需要依赖于端侧的特定实现。为了应对这些复杂性，需要提供了一定的抽象能力，使得在支持不同平台时能够灵活调整和替换模块具体实现。在设计过程中也参考了<code>iOS</code>/<code>Android</code>业界成熟的开源库，如<code>SDWebImage</code>、<code>Glide</code>和<code>Fresco</code>。</p><p>我们选择采用<code>模块化</code>和<code>架构分层</code>的思想来设计图片库的整体架构。<code>模块化</code>将图片库拆分为多个独立模块，不仅增强了系统的灵活性和可替换性，还使我们能够在不同的客户端环境和图片加载场景下进行灵活调整和扩展。<code>架构分层</code>将图片库划分为<code>Core</code>层和<code>客户端</code>层，<code>Core</code>层使用<code>C++</code>进行开发支持跨端复用，<code>客户端</code>层用于特定模块的平台差异化实现。这种设计方法有效地解决了跨端开发的复杂性问题，提高了系统的可维护性和稳定性。</p><p><img loading="lazy" src="https://img12.360buyimg.com/img/s1500x0_jfs/t1/156196/18/48708/97179/6716635eF6ae28be0/f1ea426d1b369f28.png" alt="图片库架构图" class="img_ZOZK"></p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="核心模块介绍">核心模块介绍<a href="#核心模块介绍" class="hash-link" aria-label="核心模块介绍的直接链接" title="核心模块介绍的直接链接">​</a></h4><p>图片库主要分为<code>图片缓存</code>、<code>解码器</code>、<code>图片源拉取</code>、<code>性能监控</code>、<code>图片组件</code>这几个核心功能模块，模块之间不直接依赖可以被单独调用执行。</p><h5 class="anchor anchorWithStickyNavbar_mCi1" id="图片缓存">图片缓存<a href="#图片缓存" class="hash-link" aria-label="图片缓存的直接链接" title="图片缓存的直接链接">​</a></h5><ul><li>内存缓存：用于保存已解码后的位图对象，避免每次图片加载都要进行图片解码，从而提高加载性能。我们采用<code>LRU</code>算法实现来高效利用内存，同时提供了最大内存缓存大小和设备内存紧张时回收一部分图片缓存的策略，以动态调整内存消耗。</li><li>磁盘缓存：用于保存下载后的网络图片在 APP 沙盒中，降低网络消耗并提高加载性能。提供了基础的图片读取、保存、删除、缓存大小读取等能力，同时支持多线程并行执行，实现图片磁盘缓存的高性能读写能力。</li></ul><h5 class="anchor anchorWithStickyNavbar_mCi1" id="图片数据源拉取">图片数据源拉取<a href="#图片数据源拉取" class="hash-link" aria-label="图片数据源拉取的直接链接" title="图片数据源拉取的直接链接">​</a></h5><p>图片数据源拉取模块负责图片数据源读取能力。我们在<code>HarmonyOS</code>平台上提供了多个数据源实现，处理不同格式的图片数据源拉取任务：</p><ul><li>HTTP：提供<code>HTTP</code>链接的网络图片下载能力。底层使用<code>Cornet</code>进行实现，实现高性能的多请求并行网络下载能力，同时方便未来实现跨端复用。</li><li>Base64：提供<code>Base64</code>格式的图片格式读取能力。</li></ul><h5 class="anchor anchorWithStickyNavbar_mCi1" id="解码器">解码器<a href="#解码器" class="hash-link" aria-label="解码器的直接链接" title="解码器的直接链接">​</a></h5><p>图片解码器模块负责将编码后的图片格式解码为操作系统的图片格式用于显示。我们在<code>HarmonyOS</code>平台上提供了多个解码器实现处理不同格式的图片解码任务，可以支持多线程并行执行提高解码性能。</p><ul><li>系统解码器：利用<code>HarmonyOS</code>系统提供的图片解码器可以支持<code>PNG</code>、<code>JPG</code>、<code>GIF</code>、<code>WebP</code>、<code>SVG</code>等常用图片的高性能硬件解码能力。</li><li>AVIF 解码器：由于京东 APP 大量使用<code>AVIF</code>图片格式，通过集成<code>libavif</code>库支持<code>AVIF</code>图片的解码能力。</li></ul><h5 class="anchor anchorWithStickyNavbar_mCi1" id="性能监控">性能监控<a href="#性能监控" class="hash-link" aria-label="性能监控的直接链接" title="性能监控的直接链接">​</a></h5><ul><li>加载性能监控：统计图片加载过程的各阶段耗时数据、缓存命中率、图片格式、资源消耗等信息，用来搭建图片加载性能数据平台和性能优化参考指标。</li><li>异常监控：捕获图片加载过程中的各种错误异常，用来搭建图片加载线上异常告警和根据场景进行异常重试。</li></ul><h5 class="anchor anchorWithStickyNavbar_mCi1" id="图片组件">图片组件<a href="#图片组件" class="hash-link" aria-label="图片组件的直接链接" title="图片组件的直接链接">​</a></h5><p>图片组件基于系统<code>Image</code>组件进行封装，通过<code>src</code>属性传入解码后的<code>PixelMap</code>进行渲染。同时提供了一些额外的加载属性用于提升加载性能，例如添加<code>lazy</code>属性支持图片懒加载、<code>sourceSize</code>属性指定图片显示尺寸、 <code>priority</code>属性设置加载优先级。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="性能优化">性能优化<a href="#性能优化" class="hash-link" aria-label="性能优化的直接链接" title="性能优化的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mCi1" id="图片加载流水线">图片加载流水线<a href="#图片加载流水线" class="hash-link" aria-label="图片加载流水线的直接链接" title="图片加载流水线的直接链接">​</a></h5><p><img loading="lazy" src="https://img11.360buyimg.com/img/s1500x0_jfs/t1/164538/21/52510/82513/6735a1cbF89064750/e6349d83c4379355.png" alt="图片加载流水线" class="img_ZOZK"><br>
<!-- -->图片加载流水线借鉴了<code>Fresco</code>的流水线设计。采用流水线方式可以灵活调整流水线的执行流程，可以通过搭配不同的流水线子任务以满足不同类型的图片加载任务和不同客户端的差异化诉求。同时也添加了很多优化策略提升优化图片加载流水线的执行性能。<code>图片加载流水线</code>主要包含以下这些能力：</p><ul><li>调度执行顺序：管理图片加载的流水线子任务执行顺序，确保各个步骤按照预期的顺序进行执行。</li><li>调用功能模块：灵活调用不同的功能模块，如解码、缓存、网络请求等，根据具体需求动态调整，以适应不同的图片加载任务。</li><li>线程调度：对流水线子任务进行执行线程调度，确保非主线程任务在子线程中并行执行，主线程任务在主线程中执行。使用<code>HarmonyOS</code>提供的<code>FFRT</code>框架进行高性能线程调度。</li><li>重复任务聚合：识别重复的加载任务，避免非必要的重复请求，提高加载性能。</li><li>加载监控：统计加载过程性能数据和错误异常。同时加载数据也可以用于回溯分析异常问题。</li><li>取消/重试机制：实现图片加载的取消和重试逻辑。提前取消可以降低非必要的图片加载请求，重试机制可以尽可能降低线上显示异常。</li></ul><h5 class="anchor anchorWithStickyNavbar_mCi1" id="面向京东图片服务器设计">面向京东图片服务器设计<a href="#面向京东图片服务器设计" class="hash-link" aria-label="面向京东图片服务器设计的直接链接" title="面向京东图片服务器设计的直接链接">​</a></h5><p>京东<code>图片服务器</code>提供了多种处理功能，例如图片<code>格式转换</code>、<code>图片降质</code>、<code>图片缩放</code>、<code>图片圆角</code>、<code>灰度图</code>等。这些功能通过在图片<code>URL</code>中添加特定图片处理参数实现，图片服务器会根据参数设置提前将图片处理完成并保存到<code>CDN</code>服务器。</p><p>我们可以通过在流水线预处理阶段，针对京东域名图片自动追加特定的图片处理参数降低网络流量传输消耗，例如根据视图实际显示大小添加缩放参数，添加降质参数，使用<code>.avif</code>格式图片降低网络传输大小。同时在磁盘缓存模块实现中，我们也通过实现优化策略让部分相同的图片可以进行磁盘缓存复用避免重复下载。</p><p><img loading="lazy" src="https://img14.360buyimg.com/img/s1500x0_jfs/t1/195443/1/49323/41899/67175036F3cad4599/0966c4efebe69ce4.png" alt="URL预处理" class="img_ZOZK"></p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="质量保障">质量保障<a href="#质量保障" class="hash-link" aria-label="质量保障的直接链接" title="质量保障的直接链接">​</a></h4><p>作为一个新上线的基础组件，保证业务稳定性至关重要。为了快速发现并解决问题，图片库中实现了线上监控和异常恢复机制。</p><h5 class="anchor anchorWithStickyNavbar_mCi1" id="线上监控">线上监控<a href="#线上监控" class="hash-link" aria-label="线上监控的直接链接" title="线上监控的直接链接">​</a></h5><p>####### 异常监控</p><p>如前文所述，图片加载流水线涉及多个子任务，加载异常可能出现在任何一个环节。为了精准定位问题，图片库为每个子任务定制了不同的异常对象，每个异常对象包含独特的错误码，并会根据严重程度将其分为异常和警告两个级别。当加载流程结束时会根据上报策略进行异常上报。</p><h6 class="anchor anchorWithStickyNavbar_mCi1" id="性能监控-1">性能监控<a href="#性能监控-1" class="hash-link" aria-label="性能监控的直接链接" title="性能监控的直接链接">​</a></h6><p>除了加载成功率，加载速度也是图片库的核心指标，为了能正确还原加载流程，图片库按照配置策略记录每个子任务开始和结束时间，一方面用于统计各阶段的加载耗时，另一方面还作为异常定位时的重要辅助信息。</p><h5 class="anchor anchorWithStickyNavbar_mCi1" id="异常恢复">异常恢复<a href="#异常恢复" class="hash-link" aria-label="异常恢复的直接链接" title="异常恢复的直接链接">​</a></h5><p>除了从监控发现问题，为了将异常影响降至最低，图片库也实现了流水线失败重试、组件异常降级及线上配置降级三种异常恢复机制。</p><h6 class="anchor anchorWithStickyNavbar_mCi1" id="流水线失败重试">流水线失败重试<a href="#流水线失败重试" class="hash-link" aria-label="流水线失败重试的直接链接" title="流水线失败重试的直接链接">​</a></h6><p>在图片库任务预处理阶段，会基于配置策略对图片链接进行处理，如统一图片域名，图片格式转换等等。由于图片链接拼接规则复杂，无法保证所有链接进行转化处理后仍能正常加载，因此图片库流水线中增加了重试机制，会根据错误类型使用不同的重试策略。</p><h6 class="anchor anchorWithStickyNavbar_mCi1" id="组件异常降级">组件异常降级<a href="#组件异常降级" class="hash-link" aria-label="组件异常降级的直接链接" title="组件异常降级的直接链接">​</a></h6><p>对于经过重试仍然失败的任务，图片库组件侧会尝试直接使用系统<code>Image</code>组件进行兜底渲染，以防止出现图片库特定格式兼容性的问题。<br>
<!-- -->此外，因为图片库流水线加载完成不意味着图片一定能正常渲染，图片的最终渲染成功与否取决于最终图片是否能在图片组件完成渲染上屏。因此，针对流水线成功但组件渲染失败的情况，图片库也会尝试降级到系统<code>Image</code>组件加载原始链接。<br>
<!-- -->如果降级后仍然失败，则会按照业务配置顺序加载异常兜底图。</p><h6 class="anchor anchorWithStickyNavbar_mCi1" id="线上配置降级">线上配置降级<a href="#线上配置降级" class="hash-link" aria-label="线上配置降级的直接链接" title="线上配置降级的直接链接">​</a></h6><p>由于线上环境复杂，可能会出现仅发生在特定用户、系统版本、APP 版本的异常，图片库也基于移动配置 SDK 支持了针对特定用户、机型、版本强制降级的能力。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="加载对比">加载对比<a href="#加载对比" class="hash-link" aria-label="加载对比的直接链接" title="加载对比的直接链接">​</a></h4><p><img loading="lazy" src="https://storage.360buyimg.com/jxfe/ppms/c/202410/22/b377d9f5-e767-4c14-97a6-ee0ba489c649.gif" alt="加载对比图" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="未来规划">未来规划<a href="#未来规划" class="hash-link" aria-label="未来规划的直接链接" title="未来规划的直接链接">​</a></h3><p>我们也梳理了未来可能尝试的一些图片库优化方向：</p><ul><li>网络优化：弱网优化、HTTPDNS 等策略优化图片网络下载性能。</li><li>性能优化：提高磁盘缓存/内存缓存复用率、使用堆内存池减少堆内存分配、优化 GIF 播放、低端机优化等。</li><li>适配京东图片服务器能力：利用服务器图片处理能力，如使用不同的缩放尺寸参数、清晰度、图片格式、图片域名等参数提高加载性能。</li><li>能力完善：提供更多图片加载参数、支持更多图片类型等能力满足不同业务的加载诉求。</li><li>更多平台支持：扩展到<code>iOS</code>、<code>Android</code>等更多平台。</li><li>提升图片效果：使用不同的插值方式、超分技术、HDR 等能力提高图片显示效果。</li></ul><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>京东自研的鸿蒙图片库通过模块化设计和流水线调度策略，成功解决了跨端开发的复杂性问题，同时提高了系统的可维护性和稳定性。通过实现多重异常容错机制，保证了业务的稳定性。该图片库不仅满足了京东 APP 在鸿蒙系统上的高性能图片加载需求，还为未来的跨平台开发奠定了基础。</p><p>目前，图片库已通过<code>Taro</code>集成到<code>京东</code>鸿蒙 APP 中上线使用，在图片加载体验和稳定性上有不错的表现。未来，我们将继续优化图片库的性能，扩展功能，并探索在更多平台上的应用可能。同时，我们也会持续关注业界最新的图片处理技术，不断改进我们的解决方案，为用户提供更好的图片加载体验。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="系列往期精选">系列往期精选<a href="#系列往期精选" class="hash-link" aria-label="系列往期精选的直接链接" title="系列往期精选的直接链接">​</a></h3><ul><li><a href="/taro-docs/09/11/harmony-react-on-arkts"><strong>京东鸿蒙上线前瞻——使用 Taro 打造高性能原生应用</strong></a></li><li><a href="/taro-docs/09/29/harmony-react-on-arkts"><strong>Taro 鸿蒙技术内幕系列（一）：如何将 React 代码跑在 ArkUI 上</strong></a></li><li><a href="/taro-docs/10/16/harmony-w3c-css"><strong>Taro 鸿蒙技术内幕系列（二）：如何让 W3C 标准的 CSS 跑在鸿蒙上</strong></a></li><li><a href="/taro-docs/11/01/harmony-native-events"><strong>Taro 鸿蒙技术内幕系列（三） - 多语言场景下的通用事件系统设计</strong></a></li></ul><h3 class="anchor anchorWithStickyNavbar_mCi1" id="下期预告">下期预告<a href="#下期预告" class="hash-link" aria-label="下期预告的直接链接" title="下期预告的直接链接">​</a></h3><p><img loading="lazy" src="https://img13.360buyimg.com/img/s800x0_jfs/t1/121427/40/52661/58146/6735bde4F3f037868/f6ecc76a38499abf.png" alt="下期预告" class="img_ZOZK"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2024/11/01/harmony-native-events">Taro 鸿蒙技术内幕系列（三） - 多语言场景下的通用事件系统设计</a></h2><div class="container_epbo margin-vert--md"><time datetime="2024-11-01T00:00:00.000Z" itemprop="datePublished">2024年11月1日</time> · <!-- -->阅读需 13 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NaN6T9eOyiqx9Z6.png" alt="title_logo" class="img_ZOZK"></p><blockquote><p>基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mCi1" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>在鸿蒙生态系统中，虽然原生应用通常基于 ArkTS 实现，但在实际研发过程中发现，使用 C++ 可以显著提升应用框架和业务的性能表现。随着鸿蒙系统的不断迭代升级，不同语言环境间的协作已成为不可或缺的开发范式，共同构建了更丰富的研发生态。</p><p>Taro 通过接入鸿蒙端的 <code>C-API</code> 相关能力，将组件、样式布局等运行时逻辑下沉到 C++ 层，从而极大地提升了页面的渲染性能。</p><p>在这样的背景下，构建一套在 C++、ArkTS 等不同语言环境之间高效通信的事件系统，成为了一个极具价值，对于 Taro 来说也是必修的课题。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="多语言环境的事件处理机制">多语言环境的事件处理机制<a href="#多语言环境的事件处理机制" class="hash-link" aria-label="多语言环境的事件处理机制的直接链接" title="多语言环境的事件处理机制的直接链接">​</a></h2><p>在 Harmony 端的适配过程中，事件系统扮演着双重角色：不仅驱动应用、页面和各模块组件的生命周期，还因为 ArkTS 和业务代码（JS）之间存在人为设定的界限，需要事件作为桥梁，以便 JS 能够调用 ArkTS 的原生能力。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="跨语言环境事件驱动架构的设计考量">跨语言环境事件驱动架构的设计考量<a href="#跨语言环境事件驱动架构的设计考量" class="hash-link" aria-label="跨语言环境事件驱动架构的设计考量的直接链接" title="跨语言环境事件驱动架构的设计考量的直接链接">​</a></h3><p>在设计跨语言环境的事件驱动架构时，需要同时考虑 ArkTS、JS 和 C++ 等多个语言环境的限制和运行时差异。如何实现事件在这些环境之间的有序传递，以驱动页面和组件的生命周期，是事件系统设计的重要考量。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/1_mindmap.png" alt="mindmap" class="img_ZOZK"></p><p>通过 C++ 实现事件的底层逻辑，构建一个高效的事件管理系统，可以有效避免冗余接口的设计。同时，与鸿蒙的 <code>C-API</code> 支持的事件系统对接，将各类事件分发到不同语言环境，确保跨语言环境的事件分发与处理的有序性、高效性。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/2_roadmap.png" alt="roadmap" class="img_ZOZK"></p><p>回顾 Taro 开始适配鸿蒙至今，事件系统也随之经历了从简单到完善的演进历程。从最初在 ArkTS 方案中的基础实现，到随着 Taro for Harmony 方案迭代发展，事件系统的设计也面临 ArkTS 带来的一些限制。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="在-arkts-语言环境中事件架构的局限性">在 ArkTS 语言环境中事件架构的局限性<a href="#在-arkts-语言环境中事件架构的局限性" class="hash-link" aria-label="在 ArkTS 语言环境中事件架构的局限性的直接链接" title="在 ArkTS 语言环境中事件架构的局限性的直接链接">​</a></h3><p>基于 ArkTS 语言环境实现的事件架构，在性能方面存在较大局限性。特别是在事件冒泡过程中，性能较差的语法，和回调逻辑可能会导致性能严重劣化，甚至阻塞主线程。这不仅会影响应用的响应速度，更有甚者可能对整体用户体验产生负面影响。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/3_single_thread.png" alt="single_thread" class="img_ZOZK"></p><p>为了解决这些问题，提升性能以保证用户体验成为关键目标。通过将事件处理逻辑下沉到 C++ 层，并置于后台线程执行等优化手段。能够有效提高代码执行效率，同时避免逻辑阻塞主线程导致的延迟响应，以提升应用的流畅性，提供更佳的用户体验。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/4_mutli_thread.png" alt="mutli_thread" class="img_ZOZK"></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="构建多语言环境下的事件系统">构建多语言环境下的事件系统<a href="#构建多语言环境下的事件系统" class="hash-link" aria-label="构建多语言环境下的事件系统的直接链接" title="构建多语言环境下的事件系统的直接链接">​</a></h2><p>在构建多语言环境下的事件系统时，首要考虑各种类型的事件，比如：鸿蒙提供的组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/5_1_u901a_u7528_u4e8b_u4ef6-V5" target="_blank" rel="noopener noreferrer">通用事件</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/5_3_u624b_u52bf_u5904_u7406-V5" target="_blank" rel="noopener noreferrer">手势</a>等。事件系统需要有效地管理这些不同的事件来源，并根据框架和用户的监听行为有序进行事件的分发。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/5_events.png" alt="events" class="img_ZOZK"></p><p>在这些事件类型中，大致可以分为普通事件和节点事件两类。前者涵盖系统层面和应用、组件等生命周期的变化，通常由系统或应用状态的改变触发，主要由事件中心（eventCenter）来处理；节点事件则与 <code>DOM Tree</code> 紧密相关，这些事件通常需要快速响应，以确保用户界面的流畅性和交互的即时性。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="事件中心eventcenter的实现">事件中心（eventCenter）的实现<a href="#事件中心eventcenter的实现" class="hash-link" aria-label="事件中心（eventCenter）的实现的直接链接" title="事件中心（eventCenter）的实现的直接链接">​</a></h3><p>作为 Taro 运行时中的基础模块，事件中心专注于处理系统事件和生命周期。它允许框架和应用开发者在后台线程注册事件队列，并异步分发事件，从而有效减轻主线程的负担。事件中心能够快速响应各种事件，同时具备健壮的错误处理机制，帮助开发者快速定位和解决事件回调中的问题，从而提升开发效率和系统稳定性。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="事件监听与分发">事件监听与分发<a href="#事件监听与分发" class="hash-link" aria-label="事件监听与分发的直接链接" title="事件监听与分发的直接链接">​</a></h4><p>开发者可以在 C++ 和 ArkTS 等多种语言环境中创建事件监听器，并将相应的回调函数添加到事件队列中。这一机制允许开发者在不同的编程语言中灵活地定义和处理事件响应逻辑。</p><p>当事件触发时，会根据不同语言环境的运行时差异，将事件参数转换为对应的格式。这种参数转换确保了各语言环境能够正确理解并处理事件及包含的数据，无论是简单的数据类型还是复杂的对象结构，都能在不同语言之间无缝传递。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/6_event_center.png" alt="event_center" class="img_ZOZK"></p><p>事件队列会根据监听器的类型，按照预定义的顺序，将事件分发到相应的语言环境中。这样一来，每个监听器都能在其所属的环境中高效地执行对应的回调函数。通过这种方式，不仅可以实现了跨语言的事件处理，优化事件的分发效率，并确保应用在响应用户交互时保持高性能和高稳定性。</p><blockquote><p>需要注意的是，受限于底层限制，在 ArkTS 环境中注册的事件需要回到主线程执行，同时在鸿蒙端不支持 Symbol 类型的事件。</p></blockquote><h3 class="anchor anchorWithStickyNavbar_mCi1" id="节点事件处理domevent">节点事件处理（domEvent）<a href="#节点事件处理domevent" class="hash-link" aria-label="节点事件处理（domEvent）的直接链接" title="节点事件处理（domEvent）的直接链接">​</a></h3><p>在 HTML 中，节点事件处理流程会如下图所示，事件从根节点开始向下传播至目标节点，触发后再从目标节点顺着节点树向上冒泡。在鸿蒙端实现中，Taro 基于这一事件传播流程，为开发者提供一致的事件处理机制。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="事件类型">事件类型<a href="#事件类型" class="hash-link" aria-label="事件类型的直接链接" title="事件类型的直接链接">​</a></h4><p>在 Taro 框架中，节点主要处理三种类型的事件：鸿蒙事件、鸿蒙手势事件和自定义事件。这些事件都是从  <code>TaroElement</code>  上进行监听和触发的。根据事件的类型不同，节点会从相应的事件源设置  <code>Receiver</code> （事件接收器）来进行监听并处理回调逻辑。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/7_event_dom.png" alt="event_dom" class="img_ZOZK"></p><p>鸿蒙事件和鸿蒙手势事件分别通过  <code>RenderNode</code>  注册到  <code>Receiver</code>，确保事件能够正确地传递和触发。而自定义事件则根据节点实现或用户自行触发，以满足各种不同类型的交互响应。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="事件传播">事件传播<a href="#事件传播" class="hash-link" aria-label="事件传播的直接链接" title="事件传播的直接链接">​</a></h4><p>当  <code>TaroElement</code>  上的事件被触发后，事件会沿着节点树向上传播。每个节点依次接收到事件，并执行相应的回调。执行完回调后，会检查开发者是否阻止冒泡，以决定是否继续向上传播。事件从目标节点开始，逐级往上直到根节点或者冒泡被阻止。</p><p><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/8_html_event.png" alt="html_event" class="img_ZOZK">
这允许开发者在事件传播过程中，通过任意节点处理或拦截事件来调整业务逻辑实现，以更灵活的方式在特定节点上执行逻辑，或通过阻止冒泡避免对上层节点的影响。这样的设计对于前端开发者来说，更加熟悉、直观。</p><blockquote><p>鸿蒙系统的底层节点事件也有自己的传播逻辑，但由于其机制与 <code>ArkNode</code> 节点树差异，为避免其事件干扰，需要阻止其冒泡行为并接管其传播流程，以确保事件传播与节点树正确关联。</p></blockquote><h4 class="anchor anchorWithStickyNavbar_mCi1" id="事件回调">事件回调<a href="#事件回调" class="hash-link" aria-label="事件回调的直接链接" title="事件回调的直接链接">​</a></h4><p>由于节点事件也需要回调 JS 环境中执行，根据事件类型的不同，按照 Web 标准将相应的节点、值和方法如 <code>target</code>、<code>stopPropagation</code>、<code>value</code> 等等挂载到事件对象上。通过执行当前回调的序列化方法，确保事件在不同语言环境传递时，可以保证其回调对象能力一致、参数完整。</p><p>在 C++ 中，许多组件依赖于事件机制来实现功能。例如，通过鸿蒙事件更新组件属性，还有各个组件节点间的事件传递等。这些组件利用事件机制来确保数据变化能够及时反映，并且用户交互能够顺利传递到系统的各个部分。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结与展望">总结与展望<a href="#总结与展望" class="hash-link" aria-label="总结与展望的直接链接" title="总结与展望的直接链接">​</a></h2><p>在多语言环境中，确保事件在不同语言环境传递时的一致性尤为重要，各个模块以及应用内不同页面或组件通过事件解耦驱动来提升可维护性。当前的解决方案有效提升了系统的响应速度和模块间的协作能力。</p><p>当下方案实现中仍然存在一些问题，比如早期通过事件绕过 ArkTS 与 JS 之间相互调用限制等场景，可以通过 TurboModule 来提供更加直接的调用方案。</p><p>未来，在 Taro for Harmony 场景下，各语言模块的协同将进一步增强。基于事件系统的设计，可以有效地解耦模块间逻辑，实现更灵活的组合。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="拓展阅读"><strong>拓展阅读</strong><a href="#拓展阅读" class="hash-link" aria-label="拓展阅读的直接链接" title="拓展阅读的直接链接">​</a></h3><ul><li><a href="/taro-docs/09/11/harmony-react-on-arkts"><strong>京东鸿蒙上线前瞻——使用 Taro 打造高性能原生应用</strong></a></li><li><a href="/taro-docs/09/29/harmony-react-on-arkts"><strong>Taro 鸿蒙技术内幕系列（一）：如何将 React 代码跑在 ArkUI 上</strong></a></li><li><a href="/taro-docs/10/16/harmony-w3c-css"><strong>Taro 鸿蒙技术内幕系列（二）：如何让 W3C 标准的 CSS 跑在鸿蒙上</strong></a></li></ul><h3 class="anchor anchorWithStickyNavbar_mCi1" id="下期预告"><strong>下期预告</strong><a href="#下期预告" class="hash-link" aria-label="下期预告的直接链接" title="下期预告的直接链接">​</a></h3><p><a href="http://xingyun.jd.com/shendeng/article/detail/38690" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://storage.360buyimg.com/aotu-team/zakary-blog/2024-11-01-Taro-harmony-event/next.png" alt="next" class="img_ZOZK"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2024/10/16/harmony-w3c-css">Taro 鸿蒙技术内幕系列（二）：如何让 W3C 标准的 CSS跑在鸿蒙上</a></h2><div class="container_epbo margin-vert--md"><time datetime="2024-10-16T00:00:00.000Z" itemprop="datePublished">2024年10月16日</time> · <!-- -->阅读需 17 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NaN6T9eOyiqx9Z6.png" class="img_ZOZK"></p><blockquote><p>基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mCi1" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>HarmonyOS 采用自研的 ArkUI 框架作为原生 UI 开发方案，这套方案有完善的布局系统和样式控制，但是他的标准与 W3C 的 CSS 标准存在不一致性。这意味着，如果 Taro 直接使用 HarmonyOS 提供的样式系统，开发者在使用 Taro 开发时会遇到非常多的样式兼容性问题，写出来的代码也会失去跨平台兼容的能力，与 Taro 多端统一开发的定位不符。如何抹平 ArkUI 标准和 W3C 的 CSS 标准之间的差异成了一个重中之重的任务。</p><p>本文将介绍 Taro 处理 CSS 的全流程，剖析将不同的 CSS 样式转换为 ArkUI 样式遇到的问题和对应的解决方案。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="css-样式和-arkui-capi-样式的差异和抹平">CSS 样式和 ArkUI CAPI 样式的差异和抹平<a href="#css-样式和-arkui-capi-样式的差异和抹平" class="hash-link" aria-label="CSS 样式和 ArkUI CAPI 样式的差异和抹平的直接链接" title="CSS 样式和 ArkUI CAPI 样式的差异和抹平的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mCi1" id="1样式书写方式不一致">1、样式书写方式不一致<a href="#1样式书写方式不一致" class="hash-link" aria-label="1、样式书写方式不一致的直接链接" title="1、样式书写方式不一致的直接链接">​</a></h3><p>以几个我们日常会使用到的属性为例，下面的分别是 CSS 的写法和 ArkUI CAPI 的写法。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03qlrpcJHjnf8UwTx.png" class="img_ZOZK"></p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-036HAOAmekXNOAY16R.png" class="img_ZOZK"></p><p>对比可以看出，CSS 样式和鸿蒙样式在单位系统和数据表示方式上存在显著差异。CSS 提供多样化的尺寸和颜色单位，而 ArkUI 的 CAPI 接口采用更统一的表示方式。</p><p>ArkUI 的 CAPI 接口将所有尺寸统一为 vp 单位，颜色采用 0xAARRGGBB 格式的 uint32 类型，对于渐变和 transform 等复杂样式属性，更是需要转换为颜色停止点和角度值列表和矩阵运算，这样的接口简洁但需要调用者根据具体场景完成必要的单位转换。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03m3DrlNt9ZWM9r33.png" class="img_ZOZK"></p><p>一个页面通常会包含非常多的样式规则，如果所有的单位转换都放在运行时候完成，必定会造成明显的性能问题。因此，我们选择提前完成部分转换。HTML 节点的样式主要来源于 CSS 和 Style 属性。CSS 样式通常是静态的，可以在编译阶段进行转换。为此，我们基于 lightningCSS 开发了一个 Rust 插件。该插件通过遍历项目 CSS 的抽象语法树（AST），将其转换为 ArkUI 的 CAPI 接口可直接使用的数据结构。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03Kx96fONRVSUre9b.png" class="img_ZOZK"></p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-17-49CfGeE7ci5xmvdWB.png" class="img_ZOZK"></p><p>而对于 Style 属性，其内容在运行时才能确定，因此必须在运行时进行转换。在 React 的语法中，Style 可能以字符串形式呈现，也可能是 CSS 属性名和属性值的键值对。为了有效解析 Style，我们针对各种类型的 CSS 语法写了一系列小型的 CSS 语法解析逻辑。这些逻辑能够从各种不同格式的字符串中准确匹配出属性值并进行转换。</p><p>虽然这种方法需要在运行时进行语法分析，但考虑到 Style 属性通常只包含有限的样式，加上 C++语言的高效执行特性，这种实时转换对性能的影响可以忽略不计。更为重要的是，这些运行时的 CSS 语法解析逻辑可以为后面 Taro 支持 CSS 变量提供能力支持。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="2布局存在差异">2、布局存在差异<a href="#2布局存在差异" class="hash-link" aria-label="2、布局存在差异的直接链接" title="2、布局存在差异的直接链接">​</a></h3><p>除了书写方式的差异，ArkUI 有很多布局属性的行为在细节上也和 W3C 的布局属性存在着不小的差异，比如鸿蒙的绝对定位相对父级定位，Web 的绝对定位相对最近的已定位祖先元素定位，并且鸿蒙的定位不支持 right 和 bottom（早期）。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03NUl0N103qEzwjsb.png" class="img_ZOZK"></p><p>web 可以通过 margin 的 auto 实现居中，鸿蒙能通过 flex 实现居中。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03NYxqcvPBzFwq9or.png" class="img_ZOZK"></p><p>同时， ArkUI 的 CAPI 接口缺少一些 Web 常用功能，如 calc() 计算和百分比设置支持。为消除这些差异，我们选择采用 Yoga 作为布局引擎，而非使用鸿蒙原生提供的布局。Yoga 是 Facebook 开发的开源跨平台布局引擎，实现了基于 Web 标准的 FlexBox 布局算法。使用 Yoga 可以很容易地实现对大部分 CSS 布局属性的支持，让两端的差异缩小 。</p><p>在具体实现中，我们需要在构建 Taro 节点树的同时，构建结构一致的 Yoga 节点树。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03qwUThCxxrnAvGeD.png" class="img_ZOZK"></p><p>然后把原本直接设置到鸿蒙节点上的样式属性（如宽高、margin、padding、display 和 position）设置到 Yoga 节点上。经 Yoga 计算后，我们再从 Yoga 节点上读取计算后的 width、height、x 和 y 值设置到鸿蒙节点上，从而实现鸿蒙端和 web 端的布局一致性。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-0399999U0JRKVdRoY.png" class="img_ZOZK"></p><p>通过使用 Yoga 作为布局引擎，我们不仅解决了鸿蒙系统与 Web 布局之间的差异，还提高了跨平台一致性。这种方法使开发者可以使用熟悉的 Web 布局概念，同时确保在鸿蒙平台上获得预期的布局效果。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="样式的工作流程">样式的工作流程<a href="#样式的工作流程" class="hash-link" aria-label="样式的工作流程的直接链接" title="样式的工作流程的直接链接">​</a></h2><p>介绍完 Taro 适配 ArkUI 的 CAPI 样式过程中遇到的问题和对应的解决策略之后，我们就可以来看看基于这些策略，鸿蒙样式的整个工作流程是怎么样的。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="样式初始化">样式初始化<a href="#样式初始化" class="hash-link" aria-label="样式初始化的直接链接" title="样式初始化的直接链接">​</a></h3><p>首先，项目启动后，编译器处理后的样式文件将第一个被加载到运行时环境。样式处理逻辑会根据各个选择器（selector）生成相应的样式规则（StyleRule），即 CSS 属性的键值对集合。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03KY8OrbieO3znaFI.png" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="根据-classname-匹配-stylerule">根据 ClassName 匹配 StyleRule<a href="#根据-classname-匹配-stylerule" class="hash-link" aria-label="根据 ClassName 匹配 StyleRule的直接链接" title="根据 ClassName 匹配 StyleRule的直接链接">​</a></h3><p>React 在构建每个节点的同时，会通过 Reconciler 把 React 节点的 ClassName 和 Style 设置到相应的 Taro 节点上，这个时候我们就开始进入节点的样式匹配环节。样式处理会执行以下步骤：首先，从 CSSStylesheet 这个样式集合里识别出与 className 相关的所有 StyleRule；然后，根据选择器的优先级合并这些 StyleRule；最后，将合并结果与由 Style 生成的 StyleRule 合并，从而得出最终的样式配置。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03ffn9Fza6W9mNg7m.png" class="img_ZOZK"></p><p>这里顺带提一下，CSS 除了可以书写样式之外，还可以书写伪元素和关键帧动画，这两者在都没办法直接设置到鸿蒙的样式里，在处理某个节点时，如果匹配到这个节点的样式里包含伪元素，就会把这个伪元素转换成 一次 insertBefore api 的调用，用这个新 insert 进去的子元素来承载伪元素的 StyleRule，举一个例子，下面的 F 节点的 CSS 样式里带有一个 ::after 的伪类，那么当 F 节点匹配到这个样式的时候，就会被插入一个子节点用来承载 ::after 对应的样式。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-033Djdj7rBjEv16jlI.png" class="img_ZOZK"></p><p>而对于匹配到关键帧的动画，会把动画对应的元素，动画播放的次数、播放的方向、播放的缓动函数收集起来放到另外的线程，由这个线程算出元素每一帧对应的属性值，并在元素当前帧的 StyleRule 设置完之后，设置到节点上，保证动画的优先级一定是最高的。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="样式的应用">样式的应用<a href="#样式的应用" class="hash-link" aria-label="样式的应用的直接链接" title="样式的应用的直接链接">​</a></h3><p>确定了节点对应的样式表后，我们就到了把样式应用到节点上这个环节了。这个环节我们会调用节点的 SetStyle 方法，遍历 StyleRule 中的所有样式。对于布局相关的属性（如 display、position、float、flex、width、height、margin、padding），如需更新，会被设置到节点对应的 Yoga 节点上，同时为节点本身添加 layout_dirty 标记。接着，判断是否有绘制相关的属性需要更新，如果有，则设置到节点对象的临时属性上，并为节点添加 draw_dirty 标记。这些被标记的节点并不会立刻被处理，而是会被纳入下一帧的样式处理队列中，这样能避免同一帧多次设置同一个结点的相同属性，确保样式更新的高效性，同时也能保证布局属性和绘制属性设置到鸿蒙节点时的前后时序。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03yhNRtVtNdTewURo.png" class="img_ZOZK"></p><p>在标记完所有需要更新的节点后，下一帧的样式处理流程就会对这些节点进行处理。首先，系统会调用 Yoga 的 calcYGLayout 函数，让 Yoga 从根节点开始对所有的 Yoga 节点进行测算。在此过程中，布局信息发生改变的 Yoga 节点会被打上 has_new_layout 的标记，节点上的信息也会被更新。</p><p>我们用一个例子来说明 Yoga 如何判断布局变化的影响范围：假设节点 E 的宽度改变，这可能影响到依赖父元素宽度的子元素以及由子元素撑开宽度的父元素。计算后，系统可能会更新 A、B、C、E、F、H 等节点。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-0310QvORMoGqrFB7pD.png" class="img_ZOZK"></p><p>测算完成后，我们遍历 Yoga 节点树，找出标记为 has_new_layout 的节点，并将其 width、height、x、y 值更新到对应的鸿蒙节点上。这样，所有节点的布局信息就更新完毕了。</p><p>布局更新完成后，我们再把前一帧中添加到样式处理队列的节点拿出来。将存储在节点临时对象中的绘制属性转移到鸿蒙节点上。在这个环节里大多数绘制属性可以直接设置，少量依赖节点布局信息的属性（如百分比形式的 background-size）也可以利用新计算出的布局信息来准确确定这些属性的值。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="样式的更新">样式的更新<a href="#样式的更新" class="hash-link" aria-label="样式的更新的直接链接" title="样式的更新的直接链接">​</a></h3><p>了解了初始化状态的样式工作流程后，我们再回过头来看一下样式更新部分的逻辑，在这一块逻辑里，样式的匹配和应用与前面的流程没有任何区别，所以只是简单介绍一下一个节点的样式是怎么被更新的。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="style-更新">Style 更新<a href="#style-更新" class="hash-link" aria-label="Style 更新的直接链接" title="Style 更新的直接链接">​</a></h4><p>Style 的更新是相对比较好处理的一部分，因为 Style 的影响范围只在节点的本身。当元素的 Style 更新时，我们只需要重新生成对应的 inline_style<!-- -->_<!-- -->，然后将其与通过 className 生成的样式进行合并应用即可。这个过程相对简单直接，因为不需要考虑对其他元素的影响。通过这种方式，我们可以确保元素的样式得到准确更新，同时保持整体样式系统的一致性和效率。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="classname-更新">ClassName 更新<a href="#classname-更新" class="hash-link" aria-label="ClassName 更新的直接链接" title="ClassName 更新的直接链接">​</a></h4><p>当元素的 ClassName 更新时，我们需要执行以下步骤来确保样式正确应用：</p><p>1.识别包含新 ClassName 的所有选择器规则。</p><p>2.根据 ClassName 在规则中的位置，确定需要重新进行样式匹配的元素：</p><ul><li>目标元素选择器：更新当前节点</li><li>直接后代选择器：更新直接子节点</li><li>后代选择器：更新所有子孙节点</li></ul><p>这些规则适用于 className 的增加、删除、修改和查询操作。对于 className 的修改，我们将其视为先删除旧 className 再添加新 className，并执行两次规则匹配。</p><p>举一个例子，当样式规则和元素结构如下时：</p><div class="language-test codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-test codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token plain">.E .G {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.E .H {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.I &gt; .J {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.I {}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03MLVnKT109Lq9YZEQ.png" class="img_ZOZK"></p><p>为蓝色的节点添加 className I，为红色的节点添加 className E，那么需要要被更新的节点就有 F G H I J</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-03oO6tk8XfFlPmRrb.png" class="img_ZOZK"></p><p>在实际应用中，我们还需考虑性能问题。对于大型应用或复杂的元素结构，频繁的样式重计算可能会影响性能。因此，我们采取了一种优化策略：找出需要更新的节点后，不会立即进行样式重匹配，而是将这些节点标记为&quot;脏&quot;并放入更新队列中。然后，我们在下一帧统一完成所有样式重匹配的工作。这种方法可以有效减少重复计算，提高整体性能。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>通过本文，我们详细阐述了 Taro 在处理 CSS 样式与鸿蒙系统 ArkUI 框架之间差异的全流程。我们探讨了样式书写方式的不一致性、样式匹配和应用的复杂过程，以及样式更新时的处理策略。这些功能和特性使得 Taro 能够在保持跨平台兼容性的同时，实现 CSS 样式到鸿蒙系统的有效转换。</p><p>作为开发者，我们深知这个过程中面临的挑战，但也为最终取得的成果感到自豪。通过这种方法，我们为开发者提供了一个统一且强大的多端开发解决方案，使他们能够更加高效地开发跨平台应用。</p><p>我们相信，随着技术的不断进步，未来还会出现更多的优化空间。我们将继续致力于改进 Taro 的性能和兼容性，为开发者提供更好的开发体验。同时，我们也欢迎社区的反馈和贡献，共同推动 Taro 在多端开发领域的发展。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="系列往期精选">系列往期精选<a href="#系列往期精选" class="hash-link" aria-label="系列往期精选的直接链接" title="系列往期精选的直接链接">​</a></h3><p><a href="/taro-docs/09/11/harmony-react-on-arkts">《京东鸿蒙上线前瞻——使用 Taro 打造高性能原生应用》</a></p><p><a href="/taro-docs/09/29/harmony-react-on-arkts">Taro 鸿蒙技术内幕系列（一）：如何将 React 代码跑在 ArkUI 上文章</a></p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-10-16-15-030TfLhjzRf916dOEY.png" class="img_ZOZK"></p><p><a href="/taro-docs/11/01/harmony-native-events">《Taro 鸿蒙技术内幕系列（三） - 多语言场景下的通用事件系统设计》</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2024/09/29/harmony-react-on-arkts">Taro 鸿蒙技术内幕系列（一）：如何将 React 代码跑在 ArkUI 上文章</a></h2><div class="container_epbo margin-vert--md"><time datetime="2024-09-29T00:00:00.000Z" itemprop="datePublished">2024年9月29日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NaN6T9eOyiqx9Z6.png" class="img_ZOZK"></p><blockquote><p>基于 Taro 打造的京东鸿蒙 APP 已跟随鸿蒙 Next 系统公测，本系列文章将深入解析 Taro 如何实现使用 React 开发高性能鸿蒙应用的技术内幕</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mCi1" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>随着鸿蒙操作系统的快速发展，开发者们期待将现有跨平台应用迁移到鸿蒙平台。Taro 作为一个流行的跨平台开发框架，其支持鸿蒙系统的可能性引起了广泛关注。</p><p>然而，鸿蒙系统采用全新的 ArkUI 框架作为原生 UI 开发方案，与 Taro 原本支持的平台存在显著差异。将 Taro 的 React 开发模式与 ArkUI 的声明式 UI 开发范式进行有效对接成为了一个技术难题。</p><p>本文将探讨 Taro 框架如何通过创新方案实现 React 代码在 ArkUI 上的运行。我们将解析 Taro 的运行时原理，剖析其如何将 React 组件转换为 ArkUI 可识别的结构，以及相关技术挑战和解决方案。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="taro-运行时原理介绍">Taro 运行时原理介绍<a href="#taro-运行时原理介绍" class="hash-link" aria-label="Taro 运行时原理介绍的直接链接" title="Taro 运行时原理介绍的直接链接">​</a></h3><p>为了理解 Taro 适配 ArkUI 的核心机制，我们首先需要深入了解 Taro 的运行时原理。Taro 通过巧妙的设计，将 React 代码转换为各平台可执行的形式，其中包括对鸿蒙平台的适配。下面将详细介绍 Taro 是如何将 React 代码转换为 ArkUI 可执行的形式，以及节点转换的流程细节。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35o26cuJ48IrXps9Pxy.png" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="1-从-react-到-taro">1. 从 React 到 Taro<a href="#1-从-react-到-taro" class="hash-link" aria-label="1. 从 React 到 Taro的直接链接" title="1. 从 React 到 Taro的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mCi1" id="react-跨平台的秘诀">React 跨平台的秘诀<a href="#react-跨平台的秘诀" class="hash-link" aria-label="React 跨平台的秘诀的直接链接" title="React 跨平台的秘诀的直接链接">​</a></h4><p>在 Taro 的运行时中，首先执行的是开发者编写的 React 业务代码。这些代码定义了业务应用的结构、逻辑和状态管理。那么既然要对接 React，那肯定先得了解它的核心架构，React 是怎么运作的：</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35zjLOZWNpLyg9WIv.png" class="img_ZOZK"></p><p>了解了 React 的基本架构后，我们可以清晰地看到，<code>**Renderer**</code> 作为渲染器，负责将 React 的虚拟节点操作最终映射到相应的平台上。例如，<code>react-dom</code>将这些操作对接到浏览器上，而<code>react-native</code>则将其对接到 iOS 或 Android 平台。这种设计使得 React 能够适配不同的运行环境。</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35vNxJHNqGiGD7EiB.png" class="img_ZOZK"></p><p>正是基于这种思路，Taro 团队设计了 <strong>Taro Renderer</strong>。这个渲染器充当了 React 与 Taro 虚拟节点树之间的桥梁，使得 React 的操作可以被转换为 Taro 的中间表示。</p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="通过实现-taro-renderer-生成-taro-虚拟节点树">通过实现 Taro Renderer 生成 Taro 虚拟节点树<a href="#通过实现-taro-renderer-生成-taro-虚拟节点树" class="hash-link" aria-label="通过实现 Taro Renderer 生成 Taro 虚拟节点树的直接链接" title="通过实现 Taro Renderer 生成 Taro 虚拟节点树的直接链接">​</a></h4><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NBq0KTsHmbCx9Cz.png" class="img_ZOZK"></p><p>HostConfig 接口实现</p><p>要实现 Taro 的 Renderer，我们需要实现 <code>React Reconciler</code> 所需的 <code>hostConfig</code> 接口。这个接口定义了一系列方法，用于创建、更新和管理渲染目标平台的元素。以下是一些关键的 hostConfig 方法：</p><ul><li><strong>createElement：</strong>创建 ArkUI 对应的元素。</li><li><strong>createTextInstance</strong>：创建文本节点。</li><li><strong>appendChild：</strong>将子元素添加到父元素。</li><li><strong>removeChild：</strong>从父元素中移除子元素。</li><li><strong>insertBefore：</strong>在指定位置插入元素。</li><li><strong>commitUpdate：</strong>更新元素属性。</li></ul><p>通过实现这些方法，<strong>Taro Rendere</strong>r 能够将 <strong>React 的操作转换为 Taro 虚拟节点树的相应操作</strong>。这个虚拟节点树是 Taro 实现跨平台的核心，它为不同平台的渲染提供了统一的中间表示。</p><div class="language-ts codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-ts codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 部分HostConfig接口实现的代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hostConfig</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> HostConfig </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 创建Taro虚拟节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">createInstance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Props</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _rootContainerInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _hostContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> internalInstanceHandle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Fiber</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> element</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaroElement </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TaroNativeModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createTaroNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">precacheFiberNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">internalInstanceHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> element</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">updateFiberProps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">element</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 更新属性</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">commitUpdate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updatePayload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">updatePropsByPayload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldProps</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updatePayload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">updateFiberProps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 插入节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">insertBefore</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaroElement</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> child</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaroElement</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> refChild</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaroElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insertBefore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> refChild</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 移除节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">removeChild</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaroElement</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> child TaroElement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">removeChild</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mCi1" id="2-从-taro-到-arkui">2. 从 Taro 到 ArkUI<a href="#2-从-taro-到-arkui" class="hash-link" aria-label="2. 从 Taro 到 ArkUI的直接链接" title="2. 从 Taro 到 ArkUI的直接链接">​</a></h3><p>在将 Taro 虚拟节点树转换为 ArkUI 的过程中，我们需要进行几个关键步骤：</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35NrS7935hv26Lf9xJ35.png" class="img_ZOZK"></p><p>Taro Element 转换 ArkUI 过程</p><p>首先，我们需要在 ArkUI 层面<strong>实现一套与 Taro 组件对应的组件库</strong>。这个步骤至关重要，因为它建立了 Taro 组件和 ArkUI 组件之间的映射关系。例如，我们需要为 Taro 的 <code>View</code>、<code>Text</code>、<code>Image</code> 等基础组件创建对应的 ArkUI 组件。这样，当我们遍历 Taro 虚拟节点树时，就能找到每个节点在 ArkUI 中的对应实现。</p><p>在节点映射的过程中，我们注意到 Taro 虚拟节点树与实际 ArkUI 视图结构存在差异。这些差异主要体现在以下几个方面：</p><ul><li><strong>复合组件结构：</strong>某些 Taro 组件在 ArkUI 中可能需要多个组件配合实现。例如，ScrollView 组件在 ArkUI 中可能需要一个 Scroll 节点搭配一个 Stack 来实现完整功能。</li><li><strong>层级位置调整：</strong>一些特殊定位的节点（如 Fixed 定位的元素）在最终渲染时的位置可能与其在虚拟节点树中的层级不一致。这需要在生成渲染树时进行特殊处理。</li><li><strong>平台特定组件：</strong>某些 Taro 组件可能需要使用 ArkUI 特有的组件或布局方式来实现，这要求我们在转换过程中进行适当的调整和映射。</li></ul><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35PhZHoHOEsU9f6Zg.png" class="img_ZOZK"></p><p>因此，在生成渲染树时，我们需要一个更复杂的转换过程，不仅要考虑简单的一对一映射，还要处理这些结构性的差异，确保最终生成的 ArkUI 组件树能够正确反映预期的视图结构和布局。<strong>因此，在 Taro &gt; ArkUI 的节点对接中，我们需要维护一棵 Render Tree，用于做中间的桥梁。</strong></p><h4 class="anchor anchorWithStickyNavbar_mCi1" id="1-根据组件类型-创建-taro-element">1. 根据组件类型 创建 Taro Element<a href="#1-根据组件类型-创建-taro-element" class="hash-link" aria-label="1. 根据组件类型 创建 Taro Element的直接链接" title="1. 根据组件类型 创建 Taro Element的直接链接">​</a></h4><p>在创建 Taro Element 的过程中，我们根据组件的类型来实例化相应的 Taro 元素。这一步骤是将 React 组件转换为 Taro 内部表示的关键。</p><div class="language-ts codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-ts codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 根据组件类型创建对应的Taro节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TaroElement</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> TaroDocument</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">CreateElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">napi_value </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取组件类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">TAG_NAME</span><span class="token plain"> tag_name_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TaroDOM</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">TaroElement</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">GetTagName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 根据组件类型，创建对应的实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">shared_ptr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TaroDOM</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">TaroElement</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag_name_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TAG_NAME</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">SCROLL_VIEW</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TaroDOM</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name">TaroScrollView</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TAG_NAME</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">IMAGE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TaroDOM</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name">TaroImage</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TAG_NAME</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">SPAN</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TAG_NAME</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">TEXT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TaroDOM</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name">TaroText</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TAG_NAME</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">SWIPER</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TaroDOM</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name">TaroSwiper</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mCi1" id="2-taro-element-创建-taro-rendernode">2. Taro Element 创建 Taro RenderNode<a href="#2-taro-element-创建-taro-rendernode" class="hash-link" aria-label="2. Taro Element 创建 Taro RenderNode的直接链接" title="2. Taro Element 创建 Taro RenderNode的直接链接">​</a></h4><p>在创建完 Taro Element 之后，下一步是将其转换为 Taro RenderNode。这个过程是将 Taro 的内部表示进一步转化为更接近 ArkUI 结构的渲染节点。</p><div class="language-ts codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-ts codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 创建 Taro RenderNode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> TaroSwiper</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">Build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">is_init_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// create render node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TaroElementRef element </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token generic-function function" style="color:#d73a49">static_pointer_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TaroElement</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shared_from_this</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto render_swiper </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token generic-function function" style="color:#d73a49">make_shared</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TaroSwiperNode</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">element</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        render_swiper</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">Build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mCi1" id="3-taro-rendernode-创建-arkui-node">3. Taro RenderNode 创建 ArkUI Node<a href="#3-taro-rendernode-创建-arkui-node" class="hash-link" aria-label="3. Taro RenderNode 创建 ArkUI Node的直接链接" title="3. Taro RenderNode 创建 ArkUI Node的直接链接">​</a></h4><p>最后一步是将 Taro RenderNode 转换为实际的 ArkUI 节点。这个过程涉及到直接与 ArkUI 的底层 API 交互，创建和配置 ArkUI 的原生节点。实现了从 Taro 的渲染节点到 ArkUI 实际可渲染节点的最终转换。</p><div class="language-ts codeBlockContainer_nCaG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_OzzQ"><pre tabindex="0" class="prism-code language-ts codeBlock_JYvI thin-scrollbar"><code class="codeBlockLines__Tnz"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 创建 ArkUI Node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> TaroSwiperNode</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">Build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NativeNodeApi </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nativeNodeApi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NativeNodeApi</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 创建一个Swiper的ArkUI节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetArkUINodeHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nativeNodeApi</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">createNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ARKUI_NODE_SWIPER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_lxv5"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_cFPs" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_BYBy"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_O1IT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过这三个步骤，我们在 C++ 层面成功实现了 React 组件结构到 ArkUI 原生组件结构的映射。这一过程使 Taro 应用能够在鸿蒙系统上准确地渲染和运行，为跨平台开发提供了有力支持。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>最后总结下，本文探讨了 Taro 框架如何将 React 代码成功运行在鸿蒙系统的 ArkUI 上。这个过程主要分为两个关键部分：</p><p><img loading="lazy" src="https://s3.cn-north-1.jdcloud-oss.com/shendengbucket1/2024-09-26-21-35jfyTMtdtlxvYQ69.png" class="img_ZOZK"></p><p>React &gt; ArkUI 架构图</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="1-taro-对接-react">1. Taro 对接 React<a href="#1-taro-对接-react" class="hash-link" aria-label="1. Taro 对接 React的直接链接" title="1. Taro 对接 React的直接链接">​</a></h3><p>Taro 通过实现自定义的 Renderer 来对接 React。这个 Renderer 包含了一系列方法，如 createInstance、commitUpdate 等，用于将 React 的操作转换为 Taro 虚拟节点树的操作。这个虚拟节点树是 Taro 实现跨平台的核心，为不同平台的渲染提供了统一的中间表示。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="2-taro-对接-arkui">2. Taro 对接 ArkUI<a href="#2-taro-对接-arkui" class="hash-link" aria-label="2. Taro 对接 ArkUI的直接链接" title="2. Taro 对接 ArkUI的直接链接">​</a></h3><p>Taro 通过自定义 Renderer 将 React 操作转换为虚拟节点树，然后通过三步转换过程将其映射到 ArkUI 结构。这个过程涉及 Taro Element、Taro RenderNode 和 ArkUI Node 这三棵树的维护，主要通过这三个流程步骤实现：</p><p>1.<strong>创建 Taro Element：</strong>这一步将 React 组件转换为 Taro 内部表示。</p><p>2.<strong>创建 Taro RenderNode：</strong>将 Taro 的内部表示进一步转化为更接近 ArkUI 层级结构的渲染节点。</p><p>3.<strong>创建 ArkUI Node：</strong>最后一步是将 Taro RenderNode 转换为实际的 ArkUI 节点，直接与 ArkUI 的底层 API 交互。</p><p>通过这种方式，Taro 成功地将 React 组件结构映射到 ArkUI 原生组件结构，使得 Taro 应用能够在鸿蒙系统上准确地渲染和运行，同时也为跨平台开发提供了有力支持。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="系列往期精选">系列往期精选<a href="#系列往期精选" class="hash-link" aria-label="系列往期精选的直接链接" title="系列往期精选的直接链接">​</a></h2><p><a href="/taro-docs/09/11/harmony-react-on-arkts">《京东鸿蒙上线前瞻——使用 Taro 打造高性能原生应用》</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="2024 年 1 月，京东正式启动鸿蒙原生应用开发，基于 HarmonyOS NEXT 的全场景、原生智能、原生安全等优势特性，为消费者打造更流畅、更智能、更安全的购物体验。"><header><h2 class="title_z5V4" itemprop="headline"><a itemprop="url" href="/taro-docs/blog/2024/09/11/harmony-high-performance">京东鸿蒙上线前瞻——使用 Taro 打造高性能原生应用</a></h2><div class="container_epbo margin-vert--md"><time datetime="2024-09-11T00:00:00.000Z" itemprop="datePublished">2024年9月11日</time> · <!-- -->阅读需 13 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/38971117?v=4" alt="xuanzebin" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/xuanzebin" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">xuanzebin</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Harmony 工作组 Owner</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24262362?v=4" alt="TJ" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ZakaryCode" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">TJ</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员、Taro Core 工作组</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/47267778?v=4" alt="heiazu" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/heiazu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">heiazu</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div><div class="col col--6 authorCol_Osa3"><div class="avatar margin-bottom--sm"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/24827103?v=4" alt="yoturg" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yoturg" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yoturg</span></a></div><small class="avatar__subtitle" itemprop="description">Taro 技术委员会成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mCi1" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>2024 年 1 月，京东正式启动鸿蒙原生应用开发，基于 HarmonyOS NEXT 的全场景、原生智能、原生安全等优势特性，为消费者打造更流畅、更智能、更安全的购物体验。同年 6 月，京东鸿蒙原生应用尝鲜版上架华为应用市场，计划 9 月完成正式版的上架。</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/235448/38/25755/201048/66d7d844F0baea79b/adfe087ce5348c30.png" alt="配图2.png" class="img_ZOZK"></p><p>早在 2020 年，京东与华为就签署了战略合作协议，不断加大技术投入探索 HarmonyOS 的创新特性。作为华为鸿蒙生态的首批头部合作伙伴，在适配鸿蒙操作系统的过程中，京东与华为一直保持着密切的技术沟通与共创，双方共同攻坚行业适配难点，并推动多端统一开发解决方案 Taro 在业界率先实现对鸿蒙 ArkUI 的原生开发支持。</p><p>本文将阐述京东鸿蒙原生应用在开发时所采用的技术方案、技术特点、性能表现以及未来的优化计划。<strong>通过介绍选择 Taro 作为京东鸿蒙原生应用的开发框架的原因，分析 Taro 在支持 Web 范式开发、快速迁移存量项目、渲染性能优化、高阶功能支持以及混合开发模式等方面的优势。</strong></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="技术方案">技术方案<a href="#技术方案" class="hash-link" aria-label="技术方案的直接链接" title="技术方案的直接链接">​</a></h2><p>京东在开发鸿蒙原生应用的过程中，需要考虑如何在有限的时间内高效完成项目，同时兼顾应用的性能与用户体验。为了达成这一目标，选择合适的技术方案至关重要。</p><p>在技术选型方面，开发一个鸿蒙原生应用，一般会有两种选择：</p><ul><li>使用原生 ArkTS 进行鸿蒙开发</li><li>使用跨端框架进行鸿蒙开发</li></ul><p>使用原生 ArkTS 进行鸿蒙开发，面临着<strong>开发周期冗长、维护多端多套应用代码成本高昂的挑战</strong>。在交付时间紧、任务重的情况下，京东果断选择跨端框架来开发鸿蒙原生应用，以期在有限的时间内高效完成项目。</p><p>作为在业界具备代表性的开源跨端框架之一，Taro 是由京东凹凸实验室团队开发的一款开放式跨端跨框架解决方案，它支持开发者使用一套代码，实现在 H5、小程序以及鸿蒙等多个平台上的运行。</p><p>通过 Taro 提供的编译能力，开发者可以将整个 Taro 项目轻松地转换为一个独立的鸿蒙应用，无需额外的开发工作。</p><p><img loading="lazy" src="https://img10.360buyimg.com/img/jfs/t1/92427/11/48326/91373/66d7d84aFb8575cd7/905a1ce0931eba57.png" alt="image.png" class="img_ZOZK"></p><p>另外，Taro 也支持<strong>将项目里的部分页面以模块化的形式打包进原生的鸿蒙应用中</strong>，京东鸿蒙原生应用便是使用这种模式进行开发的。</p><p>京东鸿蒙原生应用的基础基建能力如路由、定位、权限等能力由京东零售 mpass 团队来提供，而原生页面的渲染以及与基建能力的桥接则由 Taro 来负责，业务方只需要将写好的 Taro 项目通过执行相应的命令，就可以将项目以模块的形式一键打包到鸿蒙应用中，最终在应用内渲染出对应的原生页面，整个过程简单高效。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="技术特点">技术特点<a href="#技术特点" class="hash-link" aria-label="技术特点的直接链接" title="技术特点的直接链接">​</a></h2><p>Taro 作为一款开放式跨端跨框架解决方案，在支持开发者一套代码多端运行的同时，也为开发鸿蒙原生应用提供了诸多便利。在权衡多方因素后，我们最终选择了 Taro 作为开发鸿蒙原生应用的技术方案，总的来说，使用 Taro 来开发鸿蒙原生应用会有下面几点优势：</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="支持开发者使用-web-范式来开发鸿蒙原生应用">支持开发者使用 Web 范式来开发鸿蒙原生应用<a href="#支持开发者使用-web-范式来开发鸿蒙原生应用" class="hash-link" aria-label="支持开发者使用 Web 范式来开发鸿蒙原生应用的直接链接" title="支持开发者使用 Web 范式来开发鸿蒙原生应用的直接链接">​</a></h3><p>与鸿蒙原生开发相比，使用 Taro 进行开发的最大优点在于 Taro 支持开发者使用前端 Web 范式来开发鸿蒙原生应用，基于这一特点，我们<strong>对大部分 CSS 能力进行了适配</strong>：</p><ul><li>支持常见的 CSS 样式和布局，支持 flex、伪类和伪元素</li><li>支持常见的 CSS 定位，绝对定位、fixed 定位</li><li>支持常见的 CSS 选择器和媒体查询</li><li>支持常见的 CSS 单位，比如 vh、vw 以及计算属性 calc</li><li>支持 CSS 变量以及安全区域等预定义变量</li></ul><p>在编译流程上，我们<strong>采用了 Rust 编写的 LightningCSS，极大地提升了 CSS 文件的编译和解析速度</strong>。</p><p><img loading="lazy" src="https://img14.360buyimg.com/img/jfs/t1/8076/32/27814/38590/66d7d83dF04a597fa/bcfcd608361e3006.png" alt="image.png" class="img_ZOZK"></p><p>（图片来自 LightningCSS 官网）</p><p>在运行时上，我们<strong>参考了 WebKit 浏览器内核的处理流程</strong>，对于 CSS 规则的匹配和标脏进行了架构上的升级，大幅提升了 CSS 应用和更新的性能。</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/171695/16/47089/37772/66d7d83dFa03594a6/3d5e2ae2082a3236.png" alt="image.png" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="支持存量-taro-项目的快速迁移">支持存量 Taro 项目的快速迁移<a href="#支持存量-taro-项目的快速迁移" class="hash-link" aria-label="支持存量 Taro 项目的快速迁移的直接链接" title="支持存量 Taro 项目的快速迁移的直接链接">​</a></h3><p>将现有业务适配到一个全新的端侧平台，无疑需要投入大量的人力物力。而 Taro 框架的主要优势，正是能够有效解决这种跨端场景下的项目迁移难题。通过 Taro，我们可以以极低的成本，在保证高度还原和高性能的前提下，快速地将现有的 Taro 项目迁移到鸿蒙系统上。</p><p><img loading="lazy" src="https://img12.360buyimg.com/img/jfs/t1/106273/17/48258/324239/66d7d847Ff0743b4f/29415a5d30112870.png" alt="image.png" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="渲染性能比肩原生开发">渲染性能比肩原生开发<a href="#渲染性能比肩原生开发" class="hash-link" aria-label="渲染性能比肩原生开发的直接链接" title="渲染性能比肩原生开发的直接链接">​</a></h3><p>在 Taro 转换鸿蒙原生页面的技术实现上，我们摒弃了之前<a href="http://sd.jd.com/article/25595?shareId=4260&amp;isHideShareButton=1" target="_blank" rel="noopener noreferrer">使用 ArkTS 原生组件递归渲染节点树的方案</a>，<strong>将更多的运行时逻辑如组件、动效、测算和布局等逻辑下沉到了 C++ 层</strong>，极大地提升了页面的渲染性能。</p><p>另外，我们对于 Taro 项目中 CSS 样式的处理架构进行了一次整体的重构和升级，并引入布局引擎 Yoga，将页面的测量和布局放在 Taro 侧进行实现，基于这些优化，实现一套高效的渲染任务管线，使得 Taro 开发的鸿蒙页面在性能上足以和鸿蒙 ArkTS 原生页面比肩。</p><p><img loading="lazy" src="https://img13.360buyimg.com/img/jfs/t1/165604/37/47102/104631/66d7d841Fef201e37/43f11bccf8955309.png" alt="image.png" class="img_ZOZK"></p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="支持虚拟列表和节点复用等高阶功能">支持虚拟列表和节点复用等高阶功能<a href="#支持虚拟列表和节点复用等高阶功能" class="hash-link" aria-label="支持虚拟列表和节点复用等高阶功能的直接链接" title="支持虚拟列表和节点复用等高阶功能的直接链接">​</a></h3><p>长列表渲染是应用开发普遍会遇到的场景，在商品列表、订单列表、消息列表等需要无限滚动的组件和页面中广泛存在，这些场景如果不进行特殊的处理，只是单纯对数据进行渲染和更新，在数据量非常大的情况下，可能会引发严重的性能问题，导致视图在一段时间内无法响应用户操作。</p><p>在这个背景下，<strong>Taro 在鸿蒙端提供了长列表类型组件（WaterFlow &amp; List）</strong>，并对长列表类型组件进行了优化，提供了懒加载、预加载和节点复用等功能，有效地解决大数据量下的性能问题，提高应用的流畅度和用户体验。</p><p><img loading="lazy" src="https://img12.360buyimg.com/img/jfs/t1/77051/16/27856/17737/66d7d83bF4dccbb30/283c52c3099c79c5.png" alt="image.png" class="img_ZOZK"></p><p>（图片来自 HarmonyOS 官网）</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="支持原生混合开发等多种开发模式">支持原生混合开发等多种开发模式<a href="#支持原生混合开发等多种开发模式" class="hash-link" aria-label="支持原生混合开发等多种开发模式的直接链接" title="支持原生混合开发等多种开发模式的直接链接">​</a></h3><p>Taro 的组件和 API 是以小程序作为基准来进行设计的，因此在实际的鸿蒙应用开发过程中，会出现所需的组件和 API 在 Taro 中不存在的情况，因为针对这种情况，Taro 提供了原生混合开发的能力，支持将原生页面或者原生组件混合编译到 Taro 鸿蒙项目中，<strong>支持 Taro 组件和鸿蒙原生组件在页面上的混合使用</strong>。</p><p><img loading="lazy" src="https://img20.360buyimg.com/img/jfs/t1/778/17/23935/61908/66d7d843F06d0a9b1/b23cef996a033f1f.png" alt="image.png" class="img_ZOZK"></p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="性能表现">性能表现<a href="#性能表现" class="hash-link" aria-label="性能表现的直接链接" title="性能表现的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mCi1" id="京东鸿蒙原生应用性能数据">京东鸿蒙原生应用性能数据<a href="#京东鸿蒙原生应用性能数据" class="hash-link" aria-label="京东鸿蒙原生应用性能数据的直接链接" title="京东鸿蒙原生应用性能数据的直接链接">​</a></h3><p>经过对 Taro 的屡次优化和打磨，使得京东鸿蒙原生应用取得了优秀的性能表现，最终首页的渲染耗时 <strong>1062ms</strong>，相比于之前的 ArkTS 版本，性能提升了 <strong>23.9%</strong>；商详的渲染耗时 <strong>560 ms</strong>，相比于之前的 ArkTS 版本，性能提升 <strong>74.2%</strong>。</p><p>值得注意的是商详页性能提升显著，经过分析发现商详楼层众多，CSS 样式也复杂多样，因此在 ArkTS 版本中，在 CSS 的解析和属性应用阶段占用了过多的时间，在 CAPI 版本进行了 CSSOM 模块的架构升级后，带来了明显的性能提升。</p><p><img loading="lazy" src="https://img10.360buyimg.com/img/jfs/t1/82615/40/28260/13512/66d80b4eFa86acffa/d45e6b2614a8b4a7.png" alt="iShot_2024-09-03_22.57.29.png" class="img_ZOZK"></p><p>基于 Taro 开发的页面，在华为性能工厂的专业测试下，大部分都以优异的成绩通过了性能验收，充分证明了 Taro 在鸿蒙端的高性能表现。</p><h2 class="anchor anchorWithStickyNavbar_mCi1" id="总结和未来展望">总结和未来展望<a href="#总结和未来展望" class="hash-link" aria-label="总结和未来展望的直接链接" title="总结和未来展望的直接链接">​</a></h2><p>Taro 目前已经成为一个全业务域的跨端开发解决方案，实现 Web 类（如小程序、Hybrid）和原生类（iOS、Android、鸿蒙）的一体化开发，在高性能的鸿蒙适配方案的加持下，业务能快速拓展到新兴的鸿蒙系统中去，可以极大满足业务集约化开发的需求。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="未来计划">未来计划<a href="#未来计划" class="hash-link" aria-label="未来计划的直接链接" title="未来计划的直接链接">​</a></h3><p>后续，Taro 还会持续在性能上进行优化，以更好地适配鸿蒙系统：</p><ul><li><strong>将开发者的 JS 业务代码和应用框架层的 JS 代码与主线程的 UI 渲染逻辑分离</strong>，另起一条 JavaScript 线程，执行这些 JS 代码，避免上层业务逻辑堵塞主线程运行，防止页面出现卡顿、丢帧的现象。</li></ul><p><img loading="lazy" src="https://img30.360buyimg.com/img/jfs/t1/234809/21/25643/54173/66d7d845F3c696808/b048628d4306411f.png" alt="image.png" class="img_ZOZK"></p><ul><li><strong>实现视图节点拍平</strong>，将不影响布局的视图节点进行整合，减少实际绘制上屏的页面组件节点数量，提升页面的渲染性能。</li></ul><p><img loading="lazy" src="https://img20.360buyimg.com/img/jfs/t1/172158/1/46156/23746/66d7d843F8b63c336/046acd503fcc9253.png" alt="image.png" class="img_ZOZK"></p><p>（图片来自 React Native 官网）</p><ul><li><strong>实现原生性能级别的动态更新能力</strong>，支持开发者在不重新编译和发布应用的情况下，动态更新应用中的页面和功能。</li></ul><h3 class="anchor anchorWithStickyNavbar_mCi1" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3><p>京东鸿蒙原生应用是 Taro 打响在鸿蒙端侧适配的第一枪，证明了 Taro 方案适配鸿蒙原生应用的可行性。这标志着 Taro 在多端统一开发上的新突破，意味着 Taro 将为更多的企业和开发者提供优秀的跨端解决方案，使开发者能够以更高的效率开发出适配鸿蒙系统的高性能应用。</p><h3 class="anchor anchorWithStickyNavbar_mCi1" id="京东鸿蒙原生应用体验视频">京东鸿蒙原生应用体验视频<a href="#京东鸿蒙原生应用体验视频" class="hash-link" aria-label="京东鸿蒙原生应用体验视频的直接链接" title="京东鸿蒙原生应用体验视频的直接链接">​</a></h3><video src="https://ling-cdn.s3-cache-accelerate.cn-north-1.jdcloud-oss.com/ling-material-video/1418233744795033602/52f17f47e1d1a49c7b4878136041dfe8.m4v" width="100%" height="auto" controls=""></video></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_cZ5D padding--none margin-left--sm"><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/v-4">v4</a></li><li class="tag_Q_L_"><a class="tag_O1Jv tagRegular_XE6K" href="/taro-docs/blog/tags/harmony">harmony</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div><footer class="footer" id="footer"><div class="grid_c1 footer_cont"><div class="footer_logo_container"><div class="footer_logo"></div><div class="footer_designedby"></div></div><div class="footer_link_container"><div class="footer_link"><h3 class="footer_link_tit footer_link_tit1">相关资源</h3><p><a href="https://taro.jd.com/" target="_blank" rel="noopener noreferrer">Taro</a></p><p><a href="https://taro-ui.jd.com/" target="_blank" rel="noopener noreferrer">Taro UI</a></p><p><a href="https://at-ui.github.io/at-ui/#/zh" target="_blank" rel="noopener noreferrer">At-UI</a></p><p><a href="https://nerv.aotu.io/" target="_blank" rel="noopener noreferrer">Nerv</a></p><p><a href="https://athena.aotu.io/" target="_blank" rel="noopener noreferrer">Athena</a></p></div><div class="footer_link"><h3 class="footer_link_tit footer_link_tit2">社区</h3><p><a href="https://github.com/NervJS/taro/issues" target="_blank" rel="noopener noreferrer">GitHub</a></p><p class="footer_link_connect_wrap"><span class="footer_link_connect footer_link_wechat">微信<span class="wechat_qrcode_icon"><svg class="icon svgicon" viewBox="0 0 1024 1024" version="1.1" xmlns="https://www.w3.org/2000/svg" data-spm-anchor-id="a313x.7781069.0.i0"><path d="M240.071 241.095h59.278v59.278h-59.278v-59.278z" fill=""></path><path d="M405.959 134.485h-272.611v272.611h106.723v47.445h59.278v-47.445h106.723v-59.278h47.445v-47.445h-47.445l-0.114-165.888zM346.795 347.819h-154.169v-154.055h154.055v154.055h0.114zM240.071 727.154h59.278v59.278h-59.278v-59.278zM726.016 241.095h59.278v59.278h-59.278v-59.278zM512.683 509.042v63.943h59.278v-59.165h47.445v-59.278h-47.445v-47.445h-59.278v101.945zM512.683 725.789v60.643h59.278v-106.723h47.445v-59.278h-106.723v105.358zM571.961 786.432h47.445v47.445h-47.445v-47.445zM453.405 833.877v59.165h118.557v-59.165h-118.557z" fill=""></path><path d="M678.685 679.709h-59.278v106.723h106.61v-59.278h-47.331v-47.445zM726.016 893.042h166.002v-59.165h-106.723v-47.445h-59.278v106.61zM892.018 513.821v-59.278h-106.723v59.278h106.723zM832.739 727.154h59.278v59.278h-59.278v-59.278zM453.405 347.819h59.278v59.278h-59.278v-59.278zM726.016 454.542v-47.445h166.002v-272.611h-272.611v59.278h-106.723v47.445h106.723v59.165h-47.445v47.445h47.445v59.278h59.278v47.445h47.331zM678.685 193.763h154.055v154.055h-154.055v-154.055zM678.685 572.985h47.331v47.445h-47.331v-47.445zM785.294 679.709h-59.278v47.445h106.723v-106.723h59.278v-47.445h-106.723v106.723zM453.405 241.095h59.278v59.278h-59.278v-59.278zM299.349 513.821h47.445v59.165h-47.445v-59.165zM453.405 454.542h-106.61v59.278h59.165v59.165h47.445v-118.443z" fill=""></path><path d="M405.959 786.432v-106.723h47.445v-59.278h-213.333v-106.61h-106.723v59.278h59.278v47.445h-59.278v272.611h272.611v-59.278h47.445v-47.445h-47.445zM346.795 833.877h-154.169v-154.169h154.055v154.169h0.114zM453.405 572.985h59.278v47.445h-59.278v-47.445zM619.406 513.821h59.278v59.165h-59.278v-59.165zM726.016 513.821h59.278v59.165h-59.278v-59.165z" fill=""></path></svg></span></span><span class="footer_link_wechat_img"><img src="https://camo.githubusercontent.com/10834a234b99a5880b5dff7c0ca7235e2a0772e7/687474703a2f2f696d6732302e333630627579696d672e636f6d2f7562612f6a66732f7432303139372f3238332f313638373136383837342f3133363034322f32623464383131662f35623330613635634e39643166303366312e706e67"></span></p><p><a href="https://github.com/NervJS/taro/discussions" target="_blank" rel="noopener noreferrer">讨论区</a></p><div><div class="affix-contact-container inline"><div class="affix-title-inline">沟通反馈</div><div class="affix-contact-content-wrap"><div class="affix-contact-content inline"><span class="affix-contact-content-tips">选择下列对应的群，使用微信扫码添加，会收到入群二维码，再扫群码添加即可。</span><div style="display:flex;flex-flow:row wrap;justify-content:center"><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 10px 10px 0;height:100%"><img src="http://storage.360buyimg.com/taro-jd-com/static/contact_taro_qr.png" style="height:148px"><label>Taro</label></div><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 10px 10px 0;height:100%"><img src="http://storage.360buyimg.com/taro-jd-com/static/contact_taro_vue_qr.png" style="height:148px"><label>Taro Vue</label></div><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 10px 10px 0;height:100%"><img src="http://storage.360buyimg.com/taro-jd-com/static/contact_taro_rn_qr.png" style="height:148px"><label>Taro RN</label></div><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 10px 10px 0;height:100%"><img src="http://storage.360buyimg.com/taro-jd-com/static/contact_taro_harmony_qr.png" style="height:148px"><label>Taro x Harmony</label></div><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 10px 10px 0;height:100%"><img src="http://storage.360buyimg.com/taro-jd-com/static/contact_taro_lark_qr.png" style="height:148px"><label>Taro Lark</label></div><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 10px 10px 0;height:100%"><img src="http://storage.360buyimg.com/taro-jd-com/static/contact_taro_nutui_qr.png" style="height:148px"><label>Taro x NutUI</label></div></div></div></div></div></div></div><div class="footer_link"><h3 class="footer_link_tit footer_link_tit3">关于我们</h3><p><a href="https://aotu.io/" target="_blank" rel="noopener noreferrer">凹凸实验室</a></p><p><a href="mailto:taro@jd.com?subject=【Taro 合作】合作标题" target="_blank" rel="noopener noreferrer">联系我们</a></p></div><div class="footer_link"><h3 class="footer_link_tit footer_link_tit4">感谢</h3><p><a href="https://jdc.jd.com/" target="_blank" rel="noopener noreferrer">用户体验设计部</a></p><p><a href="/taro-docs/docs/team/role-committer">Taro 贡献者们</a></p></div></div></div><div class="copyright"><div class="in">Copyright © <!-- -->2025<!-- -->. All Rights Reserved. 粤ICP备15077732号-2</div></div></footer></div>
<script src="/taro-docs/assets/js/runtime~main.f8778fea.js"></script>
<script src="/taro-docs/assets/js/main.a65eca9e.js"></script>
</body>
</html>